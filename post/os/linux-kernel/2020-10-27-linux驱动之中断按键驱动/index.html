<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Linux设备驱动开发--中断用法 - Yuanye Ma's Blog
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="Yuanye Ma"><meta name=description content="Linux设备驱动开发&amp;ndash;中断用法 [TOC] 1. linux中file cdev inode之间的关系； struct file对象 ： 描述进程中打开文件的信息，包括文"><meta name=keywords content="Hugo,theme,jane"><meta name=generator content="Hugo 0.125.4"><link rel=canonical href=/post/os/linux-kernel/2020-10-27-linux%E9%A9%B1%E5%8A%A8%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%8C%89%E9%94%AE%E9%A9%B1%E5%8A%A8/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.e826e860368147e5a6685e686355e4d7789023c18c9ea2e78b35f6786ce92736.css integrity="sha256-6CboYDaBR+WmaF5oY1Xk13iQI8GMnqLnizX2eGzpJzY=" media=screen crossorigin=anonymous><meta property="og:url" content="/post/os/linux-kernel/2020-10-27-linux%E9%A9%B1%E5%8A%A8%E4%B9%8B%E4%B8%AD%E6%96%AD%E6%8C%89%E9%94%AE%E9%A9%B1%E5%8A%A8/"><meta property="og:site_name" content="Yuanye Ma's Blog"><meta property="og:title" content="Linux设备驱动开发--中断用法"><meta property="og:description" content="Linux设备驱动开发–中断用法 [TOC] 1. linux中file cdev inode之间的关系； struct file对象 ： 描述进程中打开文件的信息，包括文"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-04-15T16:01:23+08:00"><meta property="article:modified_time" content="2019-04-15T16:01:23+08:00"><meta property="article:tag" content="Kernel Interrupt"><meta property="article:tag" content="Kernel"><meta itemprop=name content="Linux设备驱动开发--中断用法"><meta itemprop=description content="Linux设备驱动开发&ndash;中断用法 [TOC] 1. linux中file cdev inode之间的关系； struct file对象 ： 描述进程中打开文件的信息，包括文"><meta itemprop=datePublished content="2019-04-15T16:01:23+08:00"><meta itemprop=dateModified content="2019-04-15T16:01:23+08:00"><meta itemprop=wordCount content="2884"><meta itemprop=keywords content="Kernel Interrupt,Kernel"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux设备驱动开发--中断用法"><meta name=twitter:description content="Linux设备驱动开发&ndash;中断用法 [TOC] 1. linux中file cdev inode之间的关系； struct file对象 ： 描述进程中打开文件的信息，包括文"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=back-to-top></div><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>功不唐捐</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>功不唐捐</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight wallpaper"><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Linux设备驱动开发--中断用法</h1><div class=post-meta><div class=post-meta-author>by
<a href=/about><span class=post-meta-author-name>Yuanye Ma</span></a></div><div class=post-meta-time><time datetime=2019-04-15>2019-04-15</time></div><div class=post-meta__right><div class=post-meta-category><a href=/categories/linux-kernel/>Linux Kernel</a></div></div></div></header><div class=post-content><h1 id=linux设备驱动开发--中断用法>Linux设备驱动开发&ndash;中断用法</h1><p>[TOC]</p><hr><h2 id=1-linux中file-cdev-inode之间的关系>1. <code>linux</code>中<code>file</code> <code>cdev</code> <code>inode</code>之间的关系；</h2><p><code>struct file</code>对象 ： 描述进程中打开文件的信息，包括文件名、读写标志、文件的当前偏移指针等。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/fs.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> file {
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * fu_list becomes invalid after file_free is called and queued via
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * fu_rcuhead for RCU freeing
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> list_head	fu_list;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> rcu_head 	fu_rcuhead;
</span></span><span style=display:flex><span>	} f_u;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> path		f_path;   
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* 略 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> file_operations	<span style=color:#f92672>*</span>f_op;  <span style=color:#75715e>// 文件操作接口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>spinlock_t</span>		f_lock;  <span style=color:#75715e>/* f_ep_links, f_flags, no IRQ */</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* 略 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>loff_t</span>			f_pos;   <span style=color:#75715e>// 文件偏移
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>struct</span> fown_struct	f_owner;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> cred	<span style=color:#f92672>*</span>f_cred;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> file_ra_state	f_ra;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* 略 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span>			<span style=color:#f92672>*</span>private_data;  <span style=color:#75715e>// 万能指针，可以用来存储私有的数据地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>/* 略 */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>struct cdev</code>对象： 描述一个字符设备对象，任何一个字符设备驱动都应该有此对象；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/cdev.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> cdev {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> kobject kobj;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> module <span style=color:#f92672>*</span>owner;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> file_operations <span style=color:#f92672>*</span>ops;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> list_head list;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>dev_t</span> dev;   <span style=color:#75715e>// 设备号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> count;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p><code>struct inode</code>对象：描述文件系统中某个文件的信息；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/fs.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> inode {
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* RCU path lookup touches following: */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>umode_t</span>			i_mode;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>uid_t</span>			i_uid;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>gid_t</span>			i_gid;
</span></span><span style=display:flex><span>	<span style=color:#75715e>/*  省略众多暂时无关的成员 */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> file_operations	<span style=color:#f92672>*</span>i_fop;	<span style=color:#75715e>/* former -&gt;i_op-&gt;default_file_ops */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> file_lock	<span style=color:#f92672>*</span>i_flock;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> address_space	<span style=color:#f92672>*</span>i_mapping;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>struct</span> address_space	i_data;
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef CONFIG_QUOTA
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>struct</span> dquot		<span style=color:#f92672>*</span>i_dquot[MAXQUOTAS];
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>struct</span> list_head	i_devices;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> pipe_inode_info	<span style=color:#f92672>*</span>i_pipe;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> block_device	<span style=color:#f92672>*</span>i_bdev;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>struct</span> cdev		<span style=color:#f92672>*</span>i_cdev;
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* 略 */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>字符设备通过<code>register_chrdev(设备号, fops)</code>将<code>cdev</code>结构体挂接在内核中<code>cdev</code>的链表上。</p><p>用户空间<code>mknod</code>的时候，会在<code>/dev/</code>下创建设备文件，该文件在内存中对应一个<code>inode</code>对象，<code>mknod</code>的设备号赋给<code>inode</code>.</p><p>用户空间<code>open()</code>的时候，通过<code>inode</code>中的<code>i_cdev</code>找到对应的<code>cdev</code>，将<code>cdev->ops</code>赋值给<code>struct file</code>的<code>f_op</code>，执行<code>f_op->open()</code>；</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* 通过inode获得主次设备号*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> minor <span style=color:#f92672>=</span> <span style=color:#a6e22e>iminot</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span> inode);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> major <span style=color:#f92672>=</span> <span style=color:#a6e22e>imajor</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span> inode);
</span></span><span style=display:flex><span><span style=color:#75715e>/* 通过filp找到inode */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span> node <span style=color:#f92672>=</span> filp<span style=color:#f92672>-&gt;</span>f_path.dentry<span style=color:#f92672>-&gt;</span>d_inode;
</span></span></code></pre></div><h2 id=2-注册字符设备的方式>2. 注册字符设备的方式</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*1.两种方式申请设备号*/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 1.1 静态申请设备号--仅仅得到设备号，注册设备*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>dev_t</span> devno <span style=color:#f92672>=</span> <span style=color:#a6e22e>MKDEV</span>(<span style=color:#ae81ff>260</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>register_chrdev_region</span>(devno, <span style=color:#ae81ff>1</span>, <span style=color:#960050;background-color:#1e0010>“</span>key_new_drv<span style=color:#960050;background-color:#1e0010>”</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>register_chrdev_region</span>(<span style=color:#66d9ef>dev_t</span> from, <span style=color:#66d9ef>unsigned</span> count, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> name);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 参数一： 设备号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 参数二： 设备的个数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 参数三： 描述字符串 --- /proc/devices
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 返回值： 0 成功， -1 失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/* 1.2 动态分配设备号*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>alloc_chrdev_region</span>(<span style=color:#66d9ef>dev_t</span> <span style=color:#f92672>*</span> dev, <span style=color:#66d9ef>unsigned</span> baseminor, <span style=color:#66d9ef>unsigned</span> count, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> name);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 参数一： 保存主设备号的变量地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 参数二： 次设备号的起始地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 参数三： 设备的个数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 参数四： 描述字符串 --- /proc/devices
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 返回值： 0 成功， -1 失败
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*2.动态分配一个cdev结构对象*/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cdev_alloc</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>/*3.初始化cdev对象*/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cdev_init</span>(<span style=color:#66d9ef>struct</span> cdev <span style=color:#f92672>*</span> cdev, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> file_operations <span style=color:#f92672>*</span> fops);
</span></span><span style=display:flex><span><span style=color:#75715e>/*4.将当前的cdev注册到系统中*/</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cdev_add</span>(<span style=color:#66d9ef>struct</span> cdev <span style=color:#f92672>*</span> p, <span style=color:#66d9ef>dev_t</span> dev, <span style=color:#66d9ef>unsigned</span> count);
</span></span><span style=display:flex><span>	<span style=color:#75715e>// 参数二：设备号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// 参数三：设备的个数，一般都填1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 
</span></span></span><span style=display:flex><span><span style=color:#75715e>	以上1、2、3、4步骤等同于用
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 int register_chrdev(unsigned int major, const char *name,
</span></span></span><span style=display:flex><span><span style=color:#75715e>				  const struct file_operations *fops)
</span></span></span><span style=display:flex><span><span style=color:#75715e>		 此函数内部会创建并初始化cdev对象， 当第一个参数为0时，自动分配设备号。
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>cdev_del</span>();
</span></span><span style=display:flex><span><span style=color:#a6e22e>unregister_chrdev</span>();
</span></span><span style=display:flex><span>unregister_chrdev_region
</span></span></code></pre></div><h2 id=3-申请中断>3. 申请中断</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// 注册中断的处理方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>int</span> __must_check
</span></span><span style=display:flex><span><span style=color:#a6e22e>request_irq</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> irq, <span style=color:#66d9ef>irq_handler_t</span> handler, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> flags,	    
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>dev)
</span></span><span style=display:flex><span>    		<span style=color:#75715e>//参数一： 中断号，  IRQ_EINT(x) x为外部中断号  arch/../mach/irqs.h中有枚举
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    		<span style=color:#f92672>//</span><span style=color:#960050;background-color:#1e0010>参数二：</span> <span style=color:#960050;background-color:#1e0010>中断处理函数</span>  <span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>irqreturn_t</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>irq_handler_t</span>)(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>    		<span style=color:#75715e>//参数三： 中断的触发方式，include/linux/interrupt.h文件中定义
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    					<span style=color:#75715e>#define IRQF_TRIGGER_NONE	0x00000000
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>#define IRQF_TRIGGER_RISING	0x00000001
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>#define IRQF_TRIGGER_FALLING	0x00000002
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>#define IRQF_TRIGGER_HIGH	0x00000004
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>#define IRQF_TRIGGER_LOW	0x00000008
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>#define IRQF_TRIGGER_MASK	(IRQF_TRIGGER_HIGH | IRQF_TRIGGER_LOW | \
</span></span></span><span style=display:flex><span><span style=color:#75715e>                                         IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#75715e>#define IRQF_TRIGGER_PROBE	0x00000010
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    		<span style=color:#75715e>//参数四： /proc/interrupts中显示的字符串
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    		<span style=color:#75715e>//参数五： 传递给中断处理函数的参数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#75715e>//返回值：
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span><span style=color:#75715e>// irq_handler_t的原型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>irqreturn_t</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>irq_handler_t</span>)(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>//返回值如下
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * enum irqreturn
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @IRQ_NONE		interrupt was not from this device
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @IRQ_HANDLED		interrupt was handled by this device
</span></span></span><span style=display:flex><span><span style=color:#75715e> * @IRQ_WAKE_THREAD	handler requests to wake the handler thread
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> irqreturn {
</span></span><span style=display:flex><span>	IRQ_NONE		<span style=color:#f92672>=</span> (<span style=color:#ae81ff>0</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>	IRQ_HANDLED		<span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>0</span>),  <span style=color:#75715e>//正常处理结束
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	IRQ_WAKE_THREAD		<span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> irqreturn <span style=color:#66d9ef>irqreturn_t</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>//释放中断
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>free_irq</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> irq, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span> dev_id)
</span></span><span style=display:flex><span>    	<span style=color:#75715e>//参数一: 中断号
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    	<span style=color:#75715e>//参数二： 和request_irq()函数的最后一个参数保持一致
</span></span></span></code></pre></div><h2 id=4-文件io模型实现之阻塞和非阻塞>4. 文件io模型实现之阻塞和非阻塞</h2><p>实现阻塞</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*实现阻塞的步骤*/</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 1 将当前进程状态设置为TASK_INTERRUPTIBLE : 可以被信号唤醒 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>set_current_state</span>(TASK_INTERRUPTIBLE);
</span></span><span style=display:flex><span><span style=color:#75715e>/* 2 将当前进程加入到一个等待队列 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>add_wait_queue</span>(<span style=color:#66d9ef>wait_queue_head_t</span> <span style=color:#f92672>*</span> q, <span style=color:#66d9ef>wait_queue_t</span> <span style=color:#f92672>*</span> wait)<span style=color:#960050;background-color:#1e0010>；</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 3 让出调度权 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>schedule</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 以上三个函数等同于wait_event_interruptible */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wait_event_interruptible</span>(<span style=color:#66d9ef>struct</span> <span style=color:#66d9ef>wait_queue_head_t</span> wq, <span style=color:#66d9ef>int</span> condition);
</span></span><span style=display:flex><span>	<span style=color:#75715e>//参数一： 等待队列头
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//参数二： 条件，如果为假，就休眠，否则继续执行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* 资源可达的时候需要唤醒进程 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>wake_up_interruptible</span>(x)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e>/* 定义一个等待队列头 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#66d9ef>wait_queue_head_t</span> wq_head;
</span></span><span style=display:flex><span><span style=color:#75715e>/* 初始化等待队列 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>init_waitqueue_head</span>(wq_head);
</span></span></code></pre></div><p>实现非阻塞</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>//在应用程序中设定非阻塞模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#34;/dev/key0&#34;</span>, O_RDWR<span style=color:#f92672>|</span>O_NOBLOCK);
</span></span><span style=display:flex><span> 	<span style=color:#75715e>// 有数据就得到数据，没有数据就得到一个出错码 -EAGAIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>//在驱动xxx_read中要区分是阻塞还是非阻塞
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>if</span> ( (filp<span style=color:#f92672>-&gt;</span>f_flags <span style=color:#f92672>&amp;</span> O_NONBLOCK) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#960050;background-color:#1e0010>没有数据</span>) <span style=color:#75715e>//非阻塞且没有数据，就返回出错码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EAGAIN;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=5-按键驱动>5. 按键驱动</h2><h3 id=v1版本>v1版本</h3><p>实现按键触发中断</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/module.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/fs.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/init.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/slab.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/device.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/interrupt.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/cdev.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define IR_GPIO GPIOH(8)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define USE_STATIC_MAJOR 1
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define KEY_MAJOR 260
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> s5pv210_key {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>dev_t</span>   devno;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> dev_major;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> irqno;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> cdev <span style=color:#f92672>*</span>cdev;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> class <span style=color:#f92672>*</span>cls;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> device <span style=color:#f92672>*</span>dev;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> s5pv210_key <span style=color:#f92672>*</span>key_dev;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>key_drv_open</span>(<span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span>inode, <span style=color:#66d9ef>struct</span> file <span style=color:#f92672>*</span>filp)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>key_drv_close</span>(<span style=color:#66d9ef>struct</span> inode <span style=color:#f92672>*</span>inode, <span style=color:#66d9ef>struct</span> file <span style=color:#f92672>*</span>filp)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34;-------^_^ %s-------</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __FUNCTION__);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> file_operations key_fops <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        .open <span style=color:#f92672>=</span> key_drv_open,
</span></span><span style=display:flex><span>        .release <span style=color:#f92672>=</span> key_drv_close,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>irqreturn_t</span> <span style=color:#a6e22e>key_irq_svc</span>(<span style=color:#66d9ef>int</span> irqno, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>dev_id)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; --------- ^-^ ---------%s </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __FUNCTION__);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> IRQ_HANDLED;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>key_drv_init</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> ret;
</span></span><span style=display:flex><span>        key_dev <span style=color:#f92672>=</span> <span style=color:#a6e22e>kzalloc</span>(<span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> s5pv210_key), GFP_KERNEL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (key_dev <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printk</span>(KERN_ERR<span style=color:#e6db74>&#34;kzalloc error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>ENOMEM;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>#ifdef USE_STATIC_MAJOR
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        key_dev<span style=color:#f92672>-&gt;</span>devno <span style=color:#f92672>=</span> <span style=color:#a6e22e>MKDEV</span>(KEY_MAJOR, <span style=color:#ae81ff>32</span>);
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>register_chrdev_region</span>(key_dev<span style=color:#f92672>-&gt;</span>devno, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;key&#34;</span>);         <span style=color:#75715e>/*申请设备号*/</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printk</span>(KERN_ERR<span style=color:#e6db74>&#34;register chrdev failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> err_free;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>alloc_chrdev_region</span>(<span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>devno, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>1</span>, <span style=color:#e6db74>&#34;key&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#75715e>/* 出错 */</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printk</span>(KERN_ERR<span style=color:#e6db74>&#34;register chrdev failed</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> err_free;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>         <span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>        key_dev<span style=color:#f92672>-&gt;</span>cdev <span style=color:#f92672>=</span> <span style=color:#a6e22e>cdev_alloc</span>();                   <span style=color:#75715e>/*动态分配一个struct cdev对象*/</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cdev_init</span>(key_dev<span style=color:#f92672>-&gt;</span>cdev, <span style=color:#f92672>&amp;</span>key_fops);            <span style=color:#75715e>/*初始化cdev的fops*/</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cdev_add</span>(key_dev<span style=color:#f92672>-&gt;</span>cdev, key_dev<span style=color:#f92672>-&gt;</span>devno, <span style=color:#ae81ff>1</span>);     <span style=color:#75715e>/*将cdev注册到系统中*/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* 自动创建设备节点 */</span>
</span></span><span style=display:flex><span>        key_dev<span style=color:#f92672>-&gt;</span>cls <span style=color:#f92672>=</span> <span style=color:#a6e22e>class_create</span>(THIS_MODULE, <span style=color:#e6db74>&#34;key_cls&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>IS_ERR</span>(key_dev<span style=color:#f92672>-&gt;</span>cls)) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printk</span>(KERN_ERR<span style=color:#e6db74>&#34;class create error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>PTR_ERR</span>(key_dev<span style=color:#f92672>-&gt;</span>cls);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> err_unregister;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        key_dev<span style=color:#f92672>-&gt;</span>dev <span style=color:#f92672>=</span> <span style=color:#a6e22e>device_create</span>(key_dev<span style=color:#f92672>-&gt;</span>cls, NULL, <span style=color:#a6e22e>MKDEV</span>(key_dev<span style=color:#f92672>-&gt;</span>dev_major, <span style=color:#ae81ff>0</span>), NULL, <span style=color:#e6db74>&#34;key%d&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>IS_ERR</span>(key_dev<span style=color:#f92672>-&gt;</span>dev)) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printk</span>(KERN_ERR<span style=color:#e6db74>&#34;device create error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>PTR_ERR</span>(key_dev<span style=color:#f92672>-&gt;</span>dev);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> err_class_destory;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* 初始化硬件 */</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 中断号获取 IRQ_EINT(x); irqs.h
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//key_dev-&gt;irqno = IRQ_EINT(1);
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        key_dev<span style=color:#f92672>-&gt;</span>irqno <span style=color:#f92672>=</span> <span style=color:#a6e22e>gpio_to_irq</span>(IR_GPIO);
</span></span><span style=display:flex><span>        ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>request_irq</span>(key_dev<span style=color:#f92672>-&gt;</span>irqno, key_irq_svc, IRQF_TRIGGER_FALLING<span style=color:#f92672>|</span>IRQF_TRIGGER_RISING, <span style=color:#e6db74>&#34;KEY&#34;</span>, NULL);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>printk</span>(KERN_ERR<span style=color:#e6db74>&#34;request irq error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>                ret <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>EBUSY;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>goto</span> err_device_destory;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>err_device_destory:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>device_destroy</span>(key_dev<span style=color:#f92672>-&gt;</span>cls, key_dev<span style=color:#f92672>-&gt;</span>devno);
</span></span><span style=display:flex><span>err_class_destory:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>class_destroy</span>(key_dev<span style=color:#f92672>-&gt;</span>cls);
</span></span><span style=display:flex><span>err_unregister:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cdev_del</span>(key_dev<span style=color:#f92672>-&gt;</span>cdev);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unregister_chrdev_region</span>(key_dev<span style=color:#f92672>-&gt;</span>devno, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>err_free:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kfree</span>(key_dev);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> ret;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> __exit <span style=color:#a6e22e>key_drv_exit</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>class_destroy</span>(key_dev<span style=color:#f92672>-&gt;</span>cls);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cdev_del</span>(key_dev<span style=color:#f92672>-&gt;</span>cdev);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>unregister_chrdev_region</span>(key_dev<span style=color:#f92672>-&gt;</span>devno, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>kfree</span>(key_dev);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>module_init</span>(key_drv_init);
</span></span><span style=display:flex><span><span style=color:#a6e22e>module_exit</span>(key_drv_exit);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>MODULE_LICENSE</span>(<span style=color:#e6db74>&#34;GPL&#34;</span>);
</span></span></code></pre></div><p><a href=https://blog.csdn.net/fang_yang_wa/article/details/55805605>基于linux操作系统下s5pv210板子的按键中断实验</a></p><p><a href=https://blog.csdn.net/fang_yang_wa/article/details/72279697>NanoPi—M1(H3)———基于该平台的一个内核中的按键中断程序开发历程</a></p><h3 id=v2版本>v2版本</h3><p>识别按键</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/input.h&gt; // KEY_DOWN</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>//设计一个按键数据包
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> key_event {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> code; <span style=color:#75715e>//按键的名字 --- 例如：下键、回车键
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> value; <span style=color:#75715e>//按键的状态 --- 按下和抬起 1/0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> s5pv210_key {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>dev_t</span>   devno;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> dev_major;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> irqno;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> cdev <span style=color:#f92672>*</span>cdev;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> class <span style=color:#f92672>*</span>cls;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> device <span style=color:#f92672>*</span>dev;
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>struct</span> key_event evnet;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> s5pv210_key <span style=color:#f92672>*</span>key_dev;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>irqreturn_t</span> <span style=color:#a6e22e>key_irq_svc</span>(<span style=color:#66d9ef>int</span> irqno, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>dev_id)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; --------- ^-^ ---------%s </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __FUNCTION__);
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>int</span> value <span style=color:#f92672>=</span> <span style=color:#a6e22e>gpio_get_value</span>(<span style=color:#a6e22e>S5PV210_GPH0</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>if</span> (value) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>/* 抬起 */</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; key up </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            key_dev<span style=color:#f92672>-&gt;</span>evnet.code <span style=color:#f92672>=</span> KEY_DOWN; <span style=color:#75715e>//#include &lt;linux/input.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            key_dev<span style=color:#f92672>-&gt;</span>event.value <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; key down </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            key_dev<span style=color:#f92672>-&gt;</span>evnet.code <span style=color:#f92672>=</span> KEY_DOWN;
</span></span><span style=display:flex><span>            key_dev<span style=color:#f92672>-&gt;</span>event.value <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;   
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> IRQ_HANDLED;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>key_drv_read</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>file</span> (filp, <span style=color:#66d9ef>char</span> __user <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>size_t</span> count, <span style=color:#66d9ef>loff_t</span> <span style=color:#f92672>*</span>fpos)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>copy_to_user</span>(buf, <span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>event, count);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34;copy_to_user error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EFAULT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>event, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> key_event));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> count;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>应用程序</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/input.h&gt; // KEY_DOWN grep -nHr &#34;KEY_DOWN&#34; /usr/include/</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> fd <span style=color:#f92672>=</span> <span style=color:#a6e22e>open</span>(<span style=color:#e6db74>&#34;/dev/key0&#34;</span>, O_RDWR);
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (fd <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;open&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>read</span>(fd, <span style=color:#f92672>&amp;</span>event, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> key_event));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;open&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);        
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (event.code <span style=color:#f92672>==</span> KEY_DOWN) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (event.value) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;KEY DOWN : UP&#34;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;KEY DOWN : DOWN&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=v3版本>v3版本</h3><p>v2版本的应用程序在运行时不停的读取按键状态，非常耗费CPU资源。考虑使用阻塞方式将读不到内容时将进程挂起。</p><p>在按键中断程序中使用阻塞方式。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/sched.h&gt; //</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;linux/wait.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>struct</span> s5pv210_key {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>dev_t</span>   devno;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> dev_major;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> irqno;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> cdev <span style=color:#f92672>*</span>cdev;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> class <span style=color:#f92672>*</span>cls;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>struct</span> device <span style=color:#f92672>*</span>dev;
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>struct</span> key_event evnet;
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>struct</span> <span style=color:#66d9ef>wait_queue_head_t</span> wq_head;
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>int</span> have_data; <span style=color:#75715e>// 一个标志，表示是否有数据，在open函数中将此标志置为0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> s5pv210_key <span style=color:#f92672>*</span>key_dev;
</span></span><span style=display:flex><span><span style=color:#75715e>/*在key_drv_init函数中初始化等待队列*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> __init <span style=color:#a6e22e>key_drv_init</span>(<span style=color:#66d9ef>void</span>) 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>init_waitqueue_head</span>(key_dev<span style=color:#f92672>-&gt;</span>wq_head);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*在read函数中如果读不到数据就将进程休眠*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>key_drv_read</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>file</span> (filp, <span style=color:#66d9ef>char</span> __user <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>size_t</span> count, <span style=color:#66d9ef>loff_t</span> <span style=color:#f92672>*</span>fpos)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>；</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*判断是否有资源*/</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wait_event_interruptible</span>(key_dev<span style=color:#f92672>-&gt;</span>wq_head, key_dev<span style=color:#f92672>-&gt;</span>have_data);    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**/</span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>copy_to_user</span>(buf, <span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>event, count);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34;copy_to_user error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EFAULT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 清空缓冲区 为下一次读取操作做准备 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>event, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> key_event));
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 同时也要清空标志 */</span>
</span></span><span style=display:flex><span>    key_dev<span style=color:#f92672>-&gt;</span>have_data <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> count;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>                     
</span></span><span style=display:flex><span><span style=color:#75715e>/* 在中断服务函数中唤醒挂起的进程 */</span>                     
</span></span><span style=display:flex><span><span style=color:#66d9ef>irqreturn_t</span> <span style=color:#a6e22e>key_irq_svc</span>(<span style=color:#66d9ef>int</span> irqno, <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>dev_id)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; --------- ^-^ ---------%s </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, __FUNCTION__);
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>int</span> value <span style=color:#f92672>=</span> <span style=color:#a6e22e>gpio_get_value</span>(<span style=color:#a6e22e>S5PV210_GPH0</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    	<span style=color:#66d9ef>if</span> (value) {
</span></span><span style=display:flex><span>            <span style=color:#75715e>/* 抬起 */</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; key up </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            key_dev<span style=color:#f92672>-&gt;</span>evnet.code <span style=color:#f92672>=</span> KEY_DOWN; <span style=color:#75715e>//#include &lt;linux/input.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            key_dev<span style=color:#f92672>-&gt;</span>event.value <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34; key down </span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>            key_dev<span style=color:#f92672>-&gt;</span>evnet.code <span style=color:#f92672>=</span> KEY_DOWN;
</span></span><span style=display:flex><span>            key_dev<span style=color:#f92672>-&gt;</span>event.value <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;   
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    	<span style=color:#75715e>/* 此时有数据可以读写了 */</span>
</span></span><span style=display:flex><span>    	key_dev<span style=color:#f92672>-&gt;</span>have_data <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    	<span style=color:#75715e>/* 唤醒等待队列 */</span>
</span></span><span style=display:flex><span>    	<span style=color:#a6e22e>wake_up_interruptible</span>(<span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>wq_head);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> IRQ_HANDLED;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>再看看驱动中区分是否阻塞需要注意的地方</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* 在本例中 */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>ssize_t</span> <span style=color:#a6e22e>key_drv_read</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>file</span> (filp, <span style=color:#66d9ef>char</span> __user <span style=color:#f92672>*</span>buf, <span style=color:#66d9ef>size_t</span> count, <span style=color:#66d9ef>loff_t</span> <span style=color:#f92672>*</span>fpos)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ret <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 区分阻塞还是非阻塞 */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ((filp<span style=color:#f92672>-&gt;</span>f_flags <span style=color:#f92672>&amp;</span> O_NONBLOCK) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>key_dev<span style=color:#f92672>-&gt;</span>have_data) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EAGAIN;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/*判断是否有资源*/</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wait_event_interruptible</span>(key_dev<span style=color:#f92672>-&gt;</span>wq_head, key_dev<span style=color:#f92672>-&gt;</span>have_data);    
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**/</span>
</span></span><span style=display:flex><span>    ret <span style=color:#f92672>=</span> <span style=color:#a6e22e>copy_to_user</span>(buf, <span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>event, count);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ret <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>){
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>printk</span>(<span style=color:#e6db74>&#34;copy_to_user error</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span>EFAULT;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 清空缓冲区 为下一次读取操作做准备 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>key_dev<span style=color:#f92672>-&gt;</span>event, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> key_event));
</span></span><span style=display:flex><span>    <span style=color:#75715e>/* 同时也要清空标志 */</span>
</span></span><span style=display:flex><span>    key_dev<span style=color:#f92672>-&gt;</span>have_data <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> count;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>手头只有NanoPi M1的板子，试验暂时还没做，加入TODO。</p></blockquote></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Yuanye Ma</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2019-04-15</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a href=https://github.com/gohugoio/hugoBasicExample rel=noopener target=_blank>See origin</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/kernel-interrupt/>Kernel interrupt</a>
<a href=/tags/kernel/>Kernel</a></div><nav class=post-nav><a class=prev href=/post/os/linux-kernel/2020-10-10-%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%9F%BA%E7%A1%80/><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i><span class="prev-text nav-default">Linux设备驱动基础</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/os/linux-kernel/linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E6%A8%A1%E5%9E%8B/><span class="next-text nav-default">Linux设备驱动模型</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg></i></a></nav></footer></article></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#1-linux中file-cdev-inode之间的关系>1. <code>linux</code>中<code>file</code> <code>cdev</code> <code>inode</code>之间的关系；</a></li><li><a href=#2-注册字符设备的方式>2. 注册字符设备的方式</a></li><li><a href=#3-申请中断>3. 申请中断</a></li><li><a href=#4-文件io模型实现之阻塞和非阻塞>4. 文件io模型实现之阻塞和非阻塞</a></li><li><a href=#5-按键驱动>5. 按键驱动</a><ul><li><a href=#v1版本>v1版本</a></li><li><a href=#v2版本>v2版本</a></li><li><a href=#v3版本>v3版本</a></li></ul></li></ul></nav></div></nav></div></main><footer id=footer class=footer><div class=icon-links><a href=yuanye.ma@qq.com rel="me noopener" class=iconfont title=email target=_blank><svg class="icon" viewBox="0 0 1451 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/YuanyeMa rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" style="" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=https://www.zhihu.com/people/mr-kevin-92 rel="me noopener" class=iconfont title=zhihu target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M351.791182 562.469462h192.945407c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262h159.282726s-.86367-67.402109-18.578124-67.402109-279.979646.0-279.979646.0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461s24.62791 5.832845 36.941354.0c12.313443-5.832845 68.050885-25.924439 84.252893-103.69571h86.570681c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262H109.86113c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449H279.868105c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513.0.0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-.055259.185218 167.855986 193.263655s22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-.045025.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"/><path d="M584.918753 182.033893v668.840094h70.318532l28.807093 80.512708 121.875768-80.512708h153.600307L959.520453 182.033893h-374.6017zM887.150192 778.934538h-79.837326l-99.578949 65.782216-23.537066-65.782216h-24.855084L659.341766 256.673847h227.807403V778.934538z"/></svg>
</a><a href="https://space.bilibili.com/159072924?spm_id_from=333.1007.0.0" rel="me noopener" class=iconfont title=bilibili target=_blank><svg class="icon" style="" viewBox="0 0 1024 1024" width="36" height="36" id="svg8"><path style="" d="M744.60599.00486267A41.779915 41.779915.0 00710.4184 18.673394L548.5048 255.32642h-11.70046a41.779915 41.779915.0 00-10.80295-7.84928L235.66 97.084498a41.779915 41.779915.0 00-20.07193-4.960864 41.779915 41.779915.0 00-18.3748 79.145436L359.4859 255.32642H128.16909c-49.458302.0-89.27932 39.82105-89.27932 89.27932v508.65224c0 49.4583 39.821018 89.27934 89.27932 89.27934h19.48445C149.12802 984.5043 179.92773 1024 224.79179 1024c44.86407.0 75.66379-39.4957 77.13826-81.46268H719.98116C721.45559 984.5043 752.25533 1024 797.1194 1024c44.86406.0 75.6638-39.4957 77.13824-81.46268h21.57323c49.45831.0 89.27936-39.82104 89.27936-89.27934V344.60574c0-49.45827-39.82105-89.27932-89.27936-89.27932H649.74567L779.38103 65.866924A41.779915 41.779915.0 00744.60599.00486267zM644.49108 418.70871c6.29985.21538 12.44451 2.01107 17.86888 5.22196l171.36218 98.10771c18.23417 10.21935 24.63334 33.34627 14.24614 51.48533-10.38726 18.13909-33.57344 24.32718-51.61587 13.77296L624.9903 489.18895c-15.21356-8.41858-22.66871-26.1765-18.03211-42.93436 4.63664-16.75784 20.15573-28.14465 37.53289-27.54588zM350.2006 432.31846c16.89952.0317 31.69582 11.33328 36.17844 27.62747 4.48262 16.2942-2.44981 33.57765-16.95507 42.24898l-140.7157 86.91312c-17.68528 11.18244-41.09629 5.77692-52.08912-12.02686-10.99282-17.80373-5.33855-41.15658 12.58167-51.95857L329.9002 438.2095c6.0643-3.86439 13.10951-5.90891 20.3004-5.89104zM501.605 641.53985c3.75002-.15248 7.48645.53903 10.93349 2.0235.15842.0637.31618.12888.47325.19582.59328.27092 1.17574.56489 1.74609.88121.15868.0854.31643.17233.47325.2611.55694.32165 1.10131.66458 1.63185 1.02807.16455.1123.32777.2265.48956.34269.50382.36781.99371.75428 1.46868 1.15864.18724.15504.37218.31282.55484.47323.43271.38784.8518.79061 1.25653 1.20756.15449.16114.30679.32437.45693.48959.40798.44266.79989.89988 1.17494 1.37076.17799.22544.35205.45395.5222.68538.25932.34701.50964.70071.75064 1.06071.26712.39516.52286.79784.76699 1.20757.16907.29043.33231.58424.48957.88123.21836.41297.42513.83199.62009 1.25653.14836.32333.28983.64976.42429.97911.21319.51552.40915 1.03801.58747 1.5666.0677.19499.13296.39085.19582.58748.18652.60823.34984 1.22334.48957 1.84399.0397.16277.0779.32601.11423.48957.1436.69112.25788 1.38801.34269 2.08877.005.0381.0111.0761.0163.11424.0857.78056.13474 1.56471.14687 2.34988.005.0543.0111.10879.0163.1632.0.0-.008 1.12132.0 1.45234.0.0-.14697 17.84761 5.89102 34.12231 3.01902 8.13734 7.33278 15.10615 12.61433 19.61501 5.28157 4.50889 11.42894 7.62081 23.64572 7.62081 12.2168.0 18.36416-3.11192 23.64573-7.62081 5.28154-4.50886 9.5953-11.47767 12.6143-19.61501 6.03799-16.2747 5.89103-34.12231 5.89103-34.12231-.44885-13.87045 10.45922-25.46302 24.3311-25.86506 13.87189-.40201 25.42828 10.53953 25.78348 24.41272.0.0 1.11929 25.7226-9.00791 53.01927-5.06359 13.64832-13.1986 28.46036-27.05631 40.29073-13.85772 11.83039-33.5454 19.63135-56.20142 19.63135-22.65603.0-42.34371-7.80096-56.20141-19.63135-4.1801-3.56856-7.78733-7.42433-10.99878-11.42303-3.21235 4.00037-6.81703 7.85309-10.99876 11.42303-13.85773 11.83039-33.5454 19.63135-56.20144 19.63135-22.65601.0-42.3437-7.80096-56.2014-19.63135-13.85775-11.83037-21.99272-26.64241-27.05632-40.29073-10.12725-27.29667-9.00789-53.01928-9.00789-53.01927.20714-13.83687 11.58744-24.88848 25.42444-24.69013 14.1263.19991 25.2971 12.0278 24.69011 26.14247.0.0-.14697 17.84761 5.89103 34.12231 3.01902 8.13734 7.31646 15.10615 12.598 19.61501 5.28155 4.50889 11.44526 7.62081 23.66203 7.62081 12.21681.0 18.36418-3.11192 23.64573-7.62081 5.28154-4.50886 9.57899-11.47767 12.598-19.61501 5.76352-15.53489 5.89112-32.05691 5.89103-33.56746.006-.37466.0111-1.05336.0163-1.20759-.0117-.74583.0105-1.49177.0652-2.23565.009-.15784.0204-.31561.0327-.47324.14204-1.56859.43163-3.12027.86487-4.63449.0213-.0763.0433-.15244.0652-.22848 3.0335-10.25748 12.24157-17.46007 22.92769-17.93417z" id="rect824"/></svg>
</a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2024
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i></span><span class=author>Yuanye Ma</span></span></div></footer><div class=button__back-to-top><a href=#back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></a></div></div><script type=text/javascript src=/lib/jquery/jquery-3.7.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.1f1ab71292e8ae0addbb90a5827f619e1cc7eba4a57b08930f33e5d8700d84be.js integrity="sha256-Hxq3EpLorgrdu5Clgn9hnhzH66SlewiTDzPl2HANhL4=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>