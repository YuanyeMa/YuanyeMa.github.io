<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Linux设备树 - Yuanye Ma's Blog
</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=author content="Yuanye Ma"><meta name=description content="Linux驱动之设备树（华清创客学院） Open Firmware Device Tree &ndash; 开发固件设备树 描述包括CPU的数量、类别、内存基地址和大小、总线和桥、外设连接、中断控制器、"><meta name=keywords content="Hugo,theme,jane"><meta name=generator content="Hugo 0.133.0"><link rel=canonical href=/post/os/linux-kernel/%E5%85%B3%E4%BA%8E%E8%AE%BE%E5%A4%87%E6%A0%91/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/sass/jane.min.e826e860368147e5a6685e686355e4d7789023c18c9ea2e78b35f6786ce92736.css integrity="sha256-6CboYDaBR+WmaF5oY1Xk13iQI8GMnqLnizX2eGzpJzY=" media=screen crossorigin=anonymous><meta property="og:url" content="/post/os/linux-kernel/%E5%85%B3%E4%BA%8E%E8%AE%BE%E5%A4%87%E6%A0%91/"><meta property="og:site_name" content="Yuanye Ma's Blog"><meta property="og:title" content="Linux设备树"><meta property="og:description" content="Linux驱动之设备树（华清创客学院） Open Firmware Device Tree – 开发固件设备树 描述包括CPU的数量、类别、内存基地址和大小、总线和桥、外设连接、中断控制器、"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-04-15T16:01:23+08:00"><meta property="article:modified_time" content="2019-04-15T16:01:23+08:00"><meta property="article:tag" content="Devicetree"><meta property="article:tag" content="Kernel Driver"><meta itemprop=name content="Linux设备树"><meta itemprop=description content="Linux驱动之设备树（华清创客学院） Open Firmware Device Tree – 开发固件设备树 描述包括CPU的数量、类别、内存基地址和大小、总线和桥、外设连接、中断控制器、"><meta itemprop=datePublished content="2019-04-15T16:01:23+08:00"><meta itemprop=dateModified content="2019-04-15T16:01:23+08:00"><meta itemprop=wordCount content="6663"><meta itemprop=keywords content="Devicetree,Kernel Driver"><meta name=twitter:card content="summary"><meta name=twitter:title content="Linux设备树"><meta name=twitter:description content="Linux驱动之设备树（华清创客学院） Open Firmware Device Tree – 开发固件设备树 描述包括CPU的数量、类别、内存基地址和大小、总线和桥、外设连接、中断控制器、"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=back-to-top></div><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>功不唐捐</a></div><div class=mobile-navbar-icon><span></span>
<span></span>
<span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=/>Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=mobile-menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav><link rel=stylesheet href=/lib/photoswipe/photoswipe.min.css><link rel=stylesheet href=/lib/photoswipe/default-skin/default-skin.min.css><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>功不唐捐</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><div id=mobile-panel><main id=main class="main bg-llight wallpaper"><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Linux设备树</h1><div class=post-meta><div class=post-meta-author>by
<a href=/about><span class=post-meta-author-name>Yuanye Ma</span></a></div><div class=post-meta-time><time datetime=2019-04-15>2019-04-15</time></div><div class=post-meta__right><div class=post-meta-category><a href=/categories/linux-kernel/>Linux Kernel</a></div></div></div></header><div class=post-content><h1 id=linux驱动之设备树华清创客学院>Linux驱动之设备树（华清创客学院）</h1><p><code>Open Firmware Device Tree</code> &ndash; 开发固件设备树</p><ol><li>描述包括CPU的数量、类别、内存基地址和大小、总线和桥、外设连接、中断控制器、GPIO控制器、Clock等。</li><li><code>ARM Linux</code>中，一个<code>.dts</code>文件对应一个<code>ARM</code>的<code>machine</code>，放置在内核的<code>arch/arm/boot/dts/</code>。</li><li><code>Device Tree</code>由一系列节点（<code>node</code>）和其属性（<code>property</code>）组成，而节点本身可以包含子节点，属性是由成对的（<code>key-value</code>）构成。</li><li><code>DTS</code>源文件由<code>DTC</code>编译为<code>DTB</code>文件，由<code>Bootloader</code>传递给内核，对其进行解析展开(<code>Flattened</code>)，从而产生硬件的拓扑图，在编程的过程中，可以直接通过系统提供的接口，获取设备树中的节点和属性信息。</li></ol><h2 id=device-tree解决的问题>Device Tree解决的问题</h2><p>在Linux 2.6中<code>arch/arm/plat-xxx</code>和<code>arch/arm/mach-xxx</code>中充斥着大量垃圾代码。如，板上的<code>platform</code>设备，<code>resource</code> <code>i2c_board_info</code> <code>spi_board_info</code> 以及各种硬件<code>platform_data</code>。这些描述板级细节的代码对内核而言都是垃圾。</p><h2 id=编译设备树>编译设备树</h2><ol><li><p><code>DTC</code>是编译设备树源文件<code>.dts</code>编译为<code>.dtb</code>的工具。</p></li><li><p><code>DTC</code>的源码位于<code>scripts/dtc/</code>,在Linux内核使能了<code>Device Tree</code>的情况下编译内核时，<code>dtc</code>会被编译出来。</p></li><li><p>在<code>arch/arm/boot/dts/Makefile</code>中，描述了当某种SOC被选中后，哪些<code>.dtb</code>文件会被编译出来。</p><p>例 <code>dtb-$(CONFIG_ARCH_EXYNOS)+=exynos4412-smdk4412.dtb exynos4412-tiny4412.dtb</code></p></li><li><p><code>make dtbs</code></p></li></ol><h2 id=缩写名词解释>缩写名词解释</h2><p>DT : Device Tree</p><p>FDT : Flattened Device Tree</p><p>OF : Open Firmware</p><p>DTS : Device Tree Source</p><p>DTSI : Device Tree Source Include</p><p>DTB : Device Tree Blob</p><p>DTC : Device Tree Compiler</p><h2 id=设备树语法>设备树语法</h2><ul><li><p>节点</p></li><li><p>属性</p></li><li><p>根节点</p></li><li><p><code>compatible</code>属性</p><p>指定了系统的名称，是一个字符串列表，实际在代码中可以用于进行匹配，至少包含一个&lt;制造商>，&lt;型号>形式的字符串，重要的是要指定一个确切的设备，并且包括制造商的名字，以避免命名空间冲突。例如：<code>compatible= "acme, coyotes-revenge;"</code></p></li><li><p><code>reg</code>属性</p><p><code>reg</code>的组织形式为 <code>reg = &lt;address1 length1 [address2 length2] ... ></code>其中每一组<code>address length</code>表明了设备使用的一个地址范围。</p></li><li><p><code>#address-cell</code>s和<code>#size-cells</code>属性</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-11>11</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#007020>#address-cells = &lt;1&gt;; 表示address字段的长度为1
</span></span></span><span style=display:flex><span><span style=color:#007020>#size-cells = &lt;1&gt;; 表示length字段的长度为1
</span></span></span><span style=display:flex><span><span style=color:#007020></span>
</span></span><span style=display:flex><span>external<span style=color:#666>-</span>bus{
</span></span><span style=display:flex><span>    <span style=color:#007020>#address-cells = &lt;2&gt; 
</span></span></span><span style=display:flex><span><span style=color:#007020></span>	<span style=color:#007020>#size-cells = &lt;1&gt;;
</span></span></span><span style=display:flex><span><span style=color:#007020></span>    ethernet<span>@</span><span style=color:#40a070>0</span>,<span style=color:#40a070>0</span>{
</span></span><span style=display:flex><span>        compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;smc, smc91c111&#34;</span>;
</span></span><span style=display:flex><span>        reg <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#40a070>0</span> <span style=color:#40a070>0</span> <span style=color:#40a070>0x1000</span><span style=color:#666>&gt;</span>; <span style=color:#60a0b0;font-style:italic>// address占两个cells, length占1个cells
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>模板</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-21>21</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#666>/</span>{
</span></span><span style=display:flex><span>    node1{
</span></span><span style=display:flex><span>        a<span style=color:#666>-</span>string<span style=color:#666>-</span>property <span style=color:#666>=</span> <span style=color:#4070a0>&#34;A String&#34;</span>;
</span></span><span style=display:flex><span>        a<span style=color:#666>-</span>string<span style=color:#666>-</span>list<span style=color:#666>-</span>property <span style=color:#666>=</span> <span style=color:#4070a0>&#34;first string&#34;</span>, <span style=color:#4070a0>&#34;second string&#34;</span>;
</span></span><span style=display:flex><span>        a<span style=color:#666>-</span>byte<span style=color:#666>-</span>data<span style=color:#666>-</span>property <span style=color:#666>=</span> [<span style=color:#40a070>0x01</span> <span style=color:#40a070>0x02</span> <span style=color:#40a070>0x03</span> <span style=color:#40a070>0x04</span>];
</span></span><span style=display:flex><span>        child<span style=color:#666>-</span>node1 {
</span></span><span style=display:flex><span>            dirst<span style=color:#666>-</span>child<span style=color:#666>-</span>property;
</span></span><span style=display:flex><span>            second<span style=color:#666>-</span>child<span style=color:#666>-</span>property<span style=color:#666>=&lt;</span><span style=color:#40a070>1</span><span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>            a<span style=color:#666>-</span>string<span style=color:#666>-</span>property<span style=color:#666>=</span><span style=color:#4070a0>&#34;Hello, world&#34;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        child<span style=color:#666>-</span>node2{
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    node2{
</span></span><span style=display:flex><span>        an<span style=color:#666>-</span>empty<span style=color:#666>-</span>property;
</span></span><span style=display:flex><span>        a<span style=color:#666>-</span>cell<span style=color:#666>-</span>property<span style=color:#666>=&lt;</span><span style=color:#40a070>1</span> <span style=color:#40a070>2</span> <span style=color:#40a070>3</span> <span style=color:#40a070>4</span><span style=color:#666>&gt;</span>; <span style=color:#60a0b0;font-style:italic>/* each number (cell) is a uint32 */</span>
</span></span><span style=display:flex><span>        child<span style=color:#666>-</span>node1{
</span></span><span style=display:flex><span>            mixed<span style=color:#666>-</span>property <span style=color:#666>=</span> <span style=color:#4070a0>&#34;a string&#34;</span>, [<span style=color:#40a070>01</span> <span style=color:#40a070>23</span> <span style=color:#40a070>45</span> <span style=color:#40a070>67</span>], <span style=color:#666>&lt;</span><span style=color:#40a070>0x12345678</span><span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li></ul><h3 id=中断信息>中断信息</h3><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>interrupt<span style=color:#666>-</span><span style=color:#002070;font-weight:700>controller</span> : <span>一个空的属性，定义该节点作为一个接受中断信号的设备</span>
</span></span><span style=display:flex><span><span style=color:#007020>#interrupt-cells : 中断控制器的属性，声明该控制器下中断的cell个数
</span></span></span><span style=display:flex><span><span style=color:#007020></span>interrupt<span style=color:#666>-</span><span style=color:#002070;font-weight:700>parent</span> : <span>设备节点属性，包含一个中断控制器的</span>phandle<span>，没有该属性的节点从父节点继承。</span>
</span></span><span style=display:flex><span><span style=color:#002070;font-weight:700>interrupts</span> : <span>设备节点属性，包含一个中断指示符列表，对应每个中断信号。</span>
</span></span></code></pre></td></tr></table></div></div><p>例</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-19>19</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#666>/</span>{
</span></span><span style=display:flex><span>    compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;acme, coyotes-revenge&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020>#address-cells = &lt;1&gt;;
</span></span></span><span style=display:flex><span><span style=color:#007020></span>    <span style=color:#007020>#size-cells = &lt;1&gt;;
</span></span></span><span style=display:flex><span><span style=color:#007020></span>    interrupt<span style=color:#666>-</span>parent<span style=color:#666>=&lt;&amp;</span>intc<span style=color:#666>&gt;</span>; <span style=color:#60a0b0;font-style:italic>/* 声明此节点以及所有子节点的中断控制器节点 */</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    serial<span>@</span><span style=color:#40a070>101f</span><span style=color:#40a070>0000</span>{
</span></span><span style=display:flex><span>        compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;arm, pl011&#34;</span>;
</span></span><span style=display:flex><span>        reg <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#40a070>0x101f0000</span> <span style=color:#40a070>0x1000</span><span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>        interrupts <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#40a070>1</span> <span style=color:#40a070>0</span><span style=color:#666>&gt;</span>; 
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>/* 对于arm架构，标志位具体含义Documentation/devicetree/bindings/arm/gic.txt */</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    intc<span>：</span> interrupt<span style=color:#666>-</span>controller<span>@</span><span style=color:#40a070>10140000</span>{
</span></span><span style=display:flex><span>        compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;arm, pl190&#34;</span>;
</span></span><span style=display:flex><span>        reg <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#40a070>0x10140000</span> <span style=color:#40a070>0x1000</span><span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>        interrupt<span style=color:#666>-</span>controller;   <span style=color:#60a0b0;font-style:italic>/* 声明此节点是一个interrupt-controller */</span>
</span></span><span style=display:flex><span>        <span style=color:#007020>#interrupt-cells = &lt;2&gt;;
</span></span></span><span style=display:flex><span><span style=color:#007020></span>    };
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>对于arm架构，标志位具体含义<code>/Documentation/devicetree/bindings/interrupt-controller/arm,gic.txt</code>,例如</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-24>24</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>- interrupt-controller : Identifies the node as an interrupt controller
</span></span><span style=display:flex><span>- <span style=color:#60a0b0;font-style:italic>#interrupt-cells : Specifies the number of cells needed to encode an</span>
</span></span><span style=display:flex><span>  interrupt source.  The <span style=color:#007020>type</span> shall be a &lt;u32&gt; and the value shall be 3.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  The 1st cell is the interrupt type; <span style=color:#40a070>0</span> <span style=color:#007020;font-weight:700>for</span> SPI interrupts, <span style=color:#40a070>1</span> <span style=color:#007020;font-weight:700>for</span> PPI
</span></span><span style=display:flex><span>  interrupts.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  The 2nd cell contains the interrupt number <span style=color:#007020;font-weight:700>for</span> the interrupt type.
</span></span><span style=display:flex><span>  SPI interrupts are in the range <span style=color:#666>[</span>0-987<span style=color:#666>]</span>.  PPI interrupts are in the
</span></span><span style=display:flex><span>  range <span style=color:#666>[</span>0-15<span style=color:#666>]</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  The 3rd cell is the flags, encoded as follows:
</span></span><span style=display:flex><span>        bits<span style=color:#666>[</span>3:0<span style=color:#666>]</span> trigger <span style=color:#007020>type</span> and level flags.
</span></span><span style=display:flex><span>                <span style=color:#bb60d5>1</span> <span style=color:#666>=</span> low-to-high edge triggered
</span></span><span style=display:flex><span>                <span style=color:#bb60d5>2</span> <span style=color:#666>=</span> high-to-low edge triggered <span style=color:#666>(</span>invalid <span style=color:#007020;font-weight:700>for</span> SPIs<span style=color:#666>)</span>
</span></span><span style=display:flex><span>                <span style=color:#bb60d5>4</span> <span style=color:#666>=</span> active high level-sensitive
</span></span><span style=display:flex><span>                <span style=color:#bb60d5>8</span> <span style=color:#666>=</span> active low level-sensitive <span style=color:#666>(</span>invalid <span style=color:#007020;font-weight:700>for</span> SPIs<span style=color:#666>)</span>.
</span></span><span style=display:flex><span>        bits<span style=color:#666>[</span>15:8<span style=color:#666>]</span> PPI interrupt cpu mask.  Each bit corresponds to each of
</span></span><span style=display:flex><span>        the <span style=color:#40a070>8</span> possible cpus attached to the GIC.  A bit <span style=color:#007020>set</span> to <span style=color:#4070a0>&#39;1&#39;</span> indicated
</span></span><span style=display:flex><span>        the interrupt is wired to that CPU.  Only valid <span style=color:#007020;font-weight:700>for</span> PPI interrupts.
</span></span><span style=display:flex><span>        Also note that the configurability of PPI interrupts is IMPLEMENTATION
</span></span><span style=display:flex><span>        DEFINED and as such not guaranteed to be present <span style=color:#666>(</span>most SoC available
</span></span><span style=display:flex><span>        in <span style=color:#40a070>2014</span> seem to ignore the setting of this flag and use the hardware
</span></span><span style=display:flex><span>        default value<span style=color:#666>)</span>.
</span></span></code></pre></td></tr></table></div></div><h2 id=常用of-api>常用OF API</h2><p><code>OF</code>提供的函数主要集中在<code>drivers/of/</code>目录下，有<code>address.c base.c device.c fdt.c irq.c platform.c</code>等等</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;of.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>/*根据device_node结构的full_name参数，在全局链表of_allnodes中，查找合适的device_node*/</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span><span style=color:#06287e>of_find_node_by_path</span>(<span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>path);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*根据property结构的name参数，在指定的device_node中查找合适的property*/</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> property <span style=color:#666>*</span><span style=color:#06287e>of_find_property</span>(<span style=color:#007020;font-weight:700>const</span> <span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span>np, <span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>name, <span style=color:#902000>int</span> <span style=color:#666>*</span>lenp);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*根据compat参数与device node的compatible匹配，返回匹配度*/</span>
</span></span><span style=display:flex><span><span style=color:#902000>int</span> <span style=color:#06287e>of_device_is_compatible</span>(<span style=color:#007020;font-weight:700>const</span> <span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span>device, <span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>compat)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*获得父节点的device node*/</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span><span style=color:#06287e>of_get_parent</span>(<span style=color:#007020;font-weight:700>const</span> <span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span>node);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*根据属性名propname, 读出该属性的数组中sz个属性值给out_values*/</span>
</span></span><span style=display:flex><span><span style=color:#902000>int</span> <span style=color:#06287e>of_property_read_u32_arry</span>(<span style=color:#007020;font-weight:700>const</span> <span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span>np, <span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>propname, u8 <span style=color:#666>*</span>out_values, <span style=color:#902000>size_t</span> sz);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*读取该设备的第index个irq号*/</span>
</span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;linux/of_irq.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span><span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> <span style=color:#06287e>irq_of_parse_and_map</span>(<span style=color:#007020;font-weight:700>struct</span> device_node <span style=color:#666>*</span>dev, <span style=color:#902000>int</span> index);
</span></span></code></pre></td></tr></table></div></div><h2 id=设备树实战>设备树实战</h2><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 将以下内容插入到dts文件中，比如 arch/arm/boot/dts/exynos4412-fs4412.dts
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>test_node<span>@</span><span style=color:#40a070>12345678</span> {
</span></span><span style=display:flex><span>	compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;test, farsight&#34;</span>;
</span></span><span style=display:flex><span>    reg <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#40a070>0xA2345678</span> <span style=color:#40a070>0x23</span>
</span></span><span style=display:flex><span>          <span style=color:#40a070>0xB3456780</span> <span style=color:#40a070>0x24</span><span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>    testprop, mytest; <span style=color:#60a0b0;font-style:italic>// 空属性
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    test_list_string <span style=color:#666>=</span> <span style=color:#4070a0>&#34;red fish&#34;</span>, <span style=color:#4070a0>&#34;bule fish&#34;</span>;
</span></span><span style=display:flex><span>    interrupt<span style=color:#666>-</span>parent <span style=color:#666>=</span> <span style=color:#666>&lt;&amp;</span>gpx1<span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>    interrupts <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#40a070>1</span> <span style=color:#40a070>2</span><span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 编译dts
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span>$</span> make dtbs
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 拷贝到开发板，并由uboot加载后
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span>$</span> cd <span style=color:#666>/</span>proc<span style=color:#666>/</span>device<span style=color:#666>-</span>tree
</span></span><span style=display:flex><span><span>$</span> ls test_node<span>@</span><span style=color:#40a070>12345678</span> <span style=color:#60a0b0;font-style:italic>//可以看到设备树中的每一个属性都是一个文件， 属性值是文件内容
</span></span></span></code></pre></td></tr></table></div></div><p>通过代码获得节点的信息</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-44>44</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-45>45</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-46>46</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-47>47</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-48>48</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-49>49</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-50>50</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-51>51</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-52>52</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-53>53</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-54>54</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-55>55</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-56>56</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-57>57</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-58>58</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-59>59</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-60>60</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-61>61</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-62>62</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-63>63</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-64>64</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-65>65</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-66>66</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-67>67</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-68>68</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-69>69</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-70>70</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-71>71</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-72><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-72>72</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-73><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-73>73</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-74><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-74>74</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-75><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-75>75</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-76><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-76>76</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-77><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-77>77</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-78><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-78>78</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-79><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-79>79</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-80><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-80>80</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-81><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-81>81</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-82><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-82>82</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-83><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-83>83</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-84><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-84>84</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-85><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-85>85</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-86><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-86>86</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-87><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-87>87</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-88><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-88>88</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>irqreturn_t</span> <span style=color:#06287e>key_irq_handler</span>(<span style=color:#902000>int</span> irqno, <span style=color:#902000>void</span> <span style=color:#666>*</span> data)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> IRQ_HANDLED;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020># include &lt;linux/of.h&gt;
</span></span></span><span style=display:flex><span><span style=color:#007020></span><span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>int</span> __init <span style=color:#06287e>led_drv_init</span>(<span style=color:#902000>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>/*获取节点的所有信息*/</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>/*a.获取节点*/</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>struct</span> devoce_node <span style=color:#666>*</span>np <span style=color:#666>=</span> <span style=color:#007020>NULL</span>;
</span></span><span style=display:flex><span>    np <span style=color:#666>=</span> <span style=color:#06287e>of_find_node_by_path</span>(<span style=color:#4070a0>&#34;/test_node@12345678&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (np) {
</span></span><span style=display:flex><span>        <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;find test node ok</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;find test node failed!</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>/* 还可以查看node的其他信息
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>        struct device_node {
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>            const char *name;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>            const char *type;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>            phandle phandle;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>            char	*full_name;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>            struct	property *properties;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>            struct	property *deadprops;	/* removed properties */</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	device_node <span style=color:#666>*</span>parent;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	device_node <span style=color:#666>*</span>child;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	device_node <span style=color:#666>*</span>sibling;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	device_node <span style=color:#666>*</span>next;	<span style=color:#60a0b0;font-style:italic>/* next device of same type */</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	device_node <span style=color:#666>*</span>allnext;	<span style=color:#60a0b0;font-style:italic>/* next in list of all nodes */</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	proc_dir_entry <span style=color:#666>*</span>pde;	<span style=color:#60a0b0;font-style:italic>/* this node&#39;s proc directory */</span>
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span>	kref kref;
</span></span><span style=display:flex><span>            <span style=color:#902000>unsigned</span> <span style=color:#902000>long</span> _flags;
</span></span><span style=display:flex><span>            <span style=color:#902000>void</span>	<span style=color:#666>*</span>data;
</span></span><span style=display:flex><span>        <span style=color:#007020>#if defined(CONFIG_SPARC)
</span></span></span><span style=display:flex><span><span style=color:#007020></span>            <span style=color:#902000>char</span>	<span style=color:#666>*</span>path_component_name;
</span></span><span style=display:flex><span>            <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> unique_id;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>struct</span> of_irq_controller <span style=color:#666>*</span>irq_trans;
</span></span><span style=display:flex><span>        <span style=color:#007020>#endif
</span></span></span><span style=display:flex><span><span style=color:#007020></span>    	};
</span></span><span style=display:flex><span>    <span>*/</span>
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>/*b.获取节点的属性*/</span> 
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>struct</span> property <span style=color:#666>*</span>prop <span style=color:#666>=</span> <span style=color:#007020>NULL</span>;
</span></span><span style=display:flex><span>    prop <span style=color:#666>=</span> <span style=color:#06287e>of_find_property</span>(np, <span style=color:#4070a0>&#34;compatible&#34;</span>, <span style=color:#007020>NULL</span>);
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>if</span> (prop) {
</span></span><span style=display:flex><span>        <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;find compatible ok : %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, prop<span style=color:#666>-&gt;</span>value);
</span></span><span style=display:flex><span>    } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;find test node failed!</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>/*c.读取属性中的整数数组*/</span>
</span></span><span style=display:flex><span>	<span style=color:#007020>#define U32_DATA_LEN 4
</span></span></span><span style=display:flex><span><span style=color:#007020></span>	u32 regdata[U32_DATA_LEN] <span style=color:#666>=</span> {<span style=color:#40a070>0</span>};
</span></span><span style=display:flex><span>	<span style=color:#902000>int</span> ret <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>	ret <span style=color:#666>=</span> <span style=color:#06287e>of_property_read_u32_array</span>(np, <span style=color:#4070a0>&#34;reg&#34;</span>, regdata, U32_DATA_LEN);
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>if</span> (<span style=color:#666>!</span>ret) {
</span></span><span style=display:flex><span>        <span style=color:#902000>int</span> i;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>for</span> (i<span style=color:#666>=</span><span style=color:#40a070>0</span>; i<span style=color:#666>&lt;</span>U32_DATA_LEN; i<span style=color:#666>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;regdata[%d] : %x</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, i, regdata[i]);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;get data of reg failed!</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>/*c.读取属性中的字符串数组*/</span>
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>pstr[<span style=color:#40a070>3</span>];
</span></span><span style=display:flex><span>    <span style=color:#902000>int</span> i;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> (i<span style=color:#666>=</span><span style=color:#40a070>0</span>; i<span style=color:#666>&lt;</span><span style=color:#40a070>3</span>; i<span style=color:#666>++</span>) {
</span></span><span style=display:flex><span>        ret <span style=color:#666>=</span> <span style=color:#06287e>of_property_read_string_index</span>(np, <span style=color:#4070a0>&#34;test_list_string&#34;</span>, i, pstr[i]);  
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> (<span style=color:#666>!</span>ret) {
</span></span><span style=display:flex><span>            <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;regdata[%d] : %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, i, pstr[i]);
</span></span><span style=display:flex><span>        } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;get data of reg failed!</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>/*d.通过查找某个属性是否存在，设置一些全局标志*/</span>
</span></span><span style=display:flex><span>	<span style=color:#007020;font-weight:700>if</span> (<span style=color:#06287e>of_find_property</span>(np, <span style=color:#4070a0>&#34;testprop,mytest&#34;</span>, <span style=color:#007020>NULL</span>)) {
</span></span><span style=display:flex><span>        is_good <span style=color:#666>=</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#06287e>printk</span>(<span style=color:#4070a0>&#34;is good = %d</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, is_good);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic>/*e.获取中断的号码*/</span>
</span></span><span style=display:flex><span>	<span style=color:#007020>#include</span> <span style=color:#007020>&lt;linux/of_irq.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span>	<span style=color:#902000>int</span> irqno <span style=color:#666>=</span> <span style=color:#06287e>irq_of_parse_and_map</span>(np, <span style=color:#40a070>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#06287e>request_irq</span>(irqno, key_irq_handler, IRQF_TRIGGER_FALLING, <span style=color:#4070a0>&#34;key_irq&#34;</span>, <span style=color:#007020>NULL</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#06287e>module_init</span>(led_drv_init);
</span></span></code></pre></td></tr></table></div></div><p>设备树匹配相关代码:</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> of_device_id of_match_id[] <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>    {.compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;test, farsight&#34;</span>}     <span style=color:#60a0b0;font-style:italic>// 和设备树中节点的compatible保持一致
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> platform_driver led_pdrv <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>    .probe <span style=color:#666>=</span> led_pdrv_probe,
</span></span><span style=display:flex><span>    .remove <span style=color:#666>=</span> led_pdrv_remove,
</span></span><span style=display:flex><span>    .driver <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>        .name <span style=color:#666>=</span> <span style=color:#4070a0>&#34;samsung led_drv&#34;</span>,
</span></span><span style=display:flex><span>        .of_match_table <span style=color:#666>=</span> of_match_id,<span style=color:#60a0b0;font-style:italic>// 设备树用此方法匹配设备和驱动，不再用.id_table
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    },
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// .id_table = led_id_table, 
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>};
</span></span></code></pre></td></tr></table></div></div><h1 id=韦东山讲设备树>韦东山讲设备树</h1><p>此部分是对前边华清创客学院所讲内容的一个补充，重点内容有</p><ol><li>内核启动时对设备树的解析；</li><li>dtb文件转换为<code>device_node</code>以及<code>device_node</code>转换为 <code>platform_device</code>的过程；</li><li>平台设备和平台驱动的匹配在其他文章中有总结过，这里主要需要注意<code>platform_match</code>函数中关于设备树匹配的方法；</li></ol><p>目前只是简单听了一遍视频课，后续抽时间对照代码再仔细研究以上内容。</p><p>韦东山设备树的第四课是<strong>u-boot对设备树的支持</strong>，留到研究<code>u-boot</code>时再细究；第五课是<strong>中断系统中的设备树</strong>这一部分涉及到内核处理中断的方式，比较复杂，也留到以后再研究。</p><h2 id=第二课-设备树的规范dts和dtb>第二课 设备树的规范【dts和dtb】</h2><h3 id=dts文件布局>DTS文件布局</h3><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#666>/</span> {
</span></span><span style=display:flex><span>	[property devinitions]
</span></span><span style=display:flex><span>	[child nodes]    
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>Property格式<span>：</span>[<span style=color:#002070;font-weight:700>label</span>:] property_name <span style=color:#666>=</span> property_value;  <span style=color:#60a0b0;font-style:italic>//也可以没有值，为空属性
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span> value <span>有三种类型</span>
</span></span><span style=display:flex><span><span style=color:#666>&lt;</span><span style=color:#40a070>1</span> <span style=color:#40a070>0x3</span> <span style=color:#40a070>0x123</span><span style=color:#666>&gt;</span>  <span>：</span> <span style=color:#40a070>32</span><span>位的数组</span>
</span></span><span style=display:flex><span><span>“</span>hello<span>”</span> <span style=color:#666>:</span> <span>字符串</span>
</span></span><span style=display:flex><span>[<span style=color:#40a070>0x11</span> <span style=color:#40a070>0x22</span> <span style=color:#40a070>0x33</span>] <span style=color:#666>:</span> byte string, <span>十六进制表示一个或者多个</span>byte<span>，一个</span>byte用2位十六进制表示<span>，</span>byte之间的空格可以省略
</span></span><span style=display:flex><span><span>三种类型可以随意组合为属性的值，不同类型之间用逗号隔开</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>Devicetree node格式
</span></span><span style=display:flex><span>[<span style=color:#002070;font-weight:700>label</span>:] node<span style=color:#666>-</span>name[<span>@</span>unit<span style=color:#666>-</span>address] {
</span></span><span style=display:flex><span>    [properties definitions]
</span></span><span style=display:flex><span>    [chile nodes]
</span></span><span style=display:flex><span>}    
</span></span></code></pre></td></tr></table></div></div><p>特殊的、默认的属性：</p><blockquote><p>a. 根节点</p><p>​ #address-cells : 在它的子节点的reg属性中，使用多少个u32整数来描述地址（address）</p><p>​ #size-cells :在它的子节点的reg属性中，使用多少个u32整数来描述地址长度(length)</p><p>​ compatible : 定义一些列的字符串，用来指定内核中哪个machine_desc可以支持本设备，即这个板子兼容哪些平台</p><p>​ model : 如果两款板子配置基本一致，他们的compatible是一样的，那么就通过model来分辨这两块板子</p><p>b. /memory</p><p>​ device_type=&ldquo;memory&rdquo;;</p><p>​ reg : 用来指定内存的</p><p>c. /chosen</p><p>​ bootargs 内核command line参数，跟u-boot中设置的bootargs作用一样。</p><p>d. /cpu/cpu*</p><p>​ device_type=&ldquo;cpu&rdquo;</p><p>​ reg : 表明自己是哪一个cpu</p></blockquote><p>引用其他节点</p><blockquote><p>a. phandle: // 节点的phandle属性，它的取值必须是唯一的（不能和其他phandle值一样）</p><p>​ pic@10000000 {</p><p>​ phandle = &lt;1>;</p><p>​ interrupt-controller; // 声明自己是一个中断控制器</p><p>​ };</p><p>​ another_device_node{</p><p>​ interrupt-parent = &lt;1>; //使用phandler值为1来引用上述节点</p><p>​ };</p><p>b. label:</p><p>​ PIC: pic@10000000 {</p><p>​ phandle = &lt;1>;</p><p>​ interrupt-controller; // 声明自己是一个中断控制器</p><p>​ };</p><p>​ another_device_node{</p><p>​ interrupt-parent = &lt;&amp;PIC>; //引用lable为PIC的节点作为中断控制器</p><p>​ };</p></blockquote><blockquote><p>如果dtsi中声明的某节点属性不满足需求，可以直接在dts文件中覆盖声明</p><p>如在 dtsi文件中声明了LED节点，但是管角和实际使用不同，可以直接引用LED的label并覆盖声明</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8>8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#666>&amp;</span>LED { <span style=color:#60a0b0;font-style:italic>// LED为dtsi文件中的一个节点label
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    pin <span style=color:#666>=</span> <span style=color:#666>&lt;</span><span style=color:#06287e>S3C2410_GPF</span>(<span style=color:#40a070>7</span>)<span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>}; <span style=color:#60a0b0;font-style:italic>//这种方法不能写在根节点下
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span>第二种覆盖声明的方法是直接在</span><span style=color:#666>/</span><span>根节点下重新覆盖声明节点</span>
</span></span><span style=display:flex><span><span style=color:#666>/</span>{
</span></span><span style=display:flex><span>      led{
</span></span><span style=display:flex><span>       	pin<span style=color:#666>=</span>  <span style=color:#666>&lt;</span><span style=color:#06287e>S3C2410_GPF</span>(<span style=color:#40a070>7</span>)<span style=color:#666>&gt;</span>;
</span></span><span style=display:flex><span>      };  
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div></blockquote><h3 id=dtb格式>DTB格式</h3><p>内核文档：/Documentation/devicetree/booting-without-of.txt</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-27>27</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-28>28</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-29>29</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-30>30</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-31>31</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-32>32</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-33>33</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-34>34</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-35>35</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-36>36</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-37>37</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-38>38</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-39>39</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-40>40</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-41>41</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-42>42</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-43>43</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-44>44</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/*           ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>---- base -&gt; |  struct boot_param_header  |  // 指示各个段的偏移地址
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |      (alignment gap) (*)   |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |      memory reserve map    |  //
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |      (alignment gap)       |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |                            |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |    device-tree structure   |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |                            |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |      (alignment gap)       |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |                            |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |     device-tree strings    |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>             |                            |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>      -----&gt; ------------------------------
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>      |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>      |
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>      --- (base + totalsize)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>*/</span> 
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> boot_param_header { 
</span></span><span style=display:flex><span>		u32     magic;                  <span style=color:#60a0b0;font-style:italic>/* magic word OF_DT_HEADER  0xd00dfeed */</span>
</span></span><span style=display:flex><span>        u32     totalsize;              <span style=color:#60a0b0;font-style:italic>/* total size of DT block */</span>
</span></span><span style=display:flex><span>        u32     off_dt_struct;          <span style=color:#60a0b0;font-style:italic>/* offset to structure */</span>
</span></span><span style=display:flex><span>        u32     off_dt_strings;         <span style=color:#60a0b0;font-style:italic>/* offset to strings */</span>
</span></span><span style=display:flex><span>        u32     off_mem_rsvmap;         <span style=color:#60a0b0;font-style:italic>/* offset to memory reserve map*/</span> 
</span></span><span style=display:flex><span>    	u32     version;                <span style=color:#60a0b0;font-style:italic>/* format version */</span>
</span></span><span style=display:flex><span>        u32     last_comp_version;      <span style=color:#60a0b0;font-style:italic>/* last compatible version */</span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>/* version 2 fields below */</span>
</span></span><span style=display:flex><span>        u32     boot_cpuid_phys;        <span style=color:#60a0b0;font-style:italic>/* Which physical CPU id we&#39;re booting on */</span> 
</span></span><span style=display:flex><span>    	<span style=color:#60a0b0;font-style:italic>/* version 3 fields below */</span>
</span></span><span style=display:flex><span>        u32     size_dt_strings;        <span style=color:#60a0b0;font-style:italic>/* size of the strings block */</span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>/* version 17 fields below */</span>
</span></span><span style=display:flex><span>        u32	size_dt_struct;		<span style=color:#60a0b0;font-style:italic>/* size of the DT structure block */</span> 
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>   Along with the <span style=color:#002070;font-weight:700>constants</span>:
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>/* Definitions used by the flattened device tree */</span> 
</span></span><span style=display:flex><span><span style=color:#007020>#define OF_DT_HEADER            0xd00dfeed      </span><span style=color:#60a0b0;font-style:italic>/* 4: version, 4: total size */</span><span style=color:#007020> 
</span></span></span><span style=display:flex><span><span style=color:#007020>#define OF_DT_BEGIN_NODE        0x1             </span><span style=color:#60a0b0;font-style:italic>/* Start node: full name*/</span><span style=color:#007020> 
</span></span></span><span style=display:flex><span><span style=color:#007020>#define OF_DT_END_NODE          0x2             </span><span style=color:#60a0b0;font-style:italic>/* End node */</span><span style=color:#007020> 
</span></span></span><span style=display:flex><span><span style=color:#007020>#define OF_DT_PROP              0x3             </span><span style=color:#60a0b0;font-style:italic>/* Property: name off, size, content */</span><span style=color:#007020> #define OF_DT_END               0x9             </span><span style=color:#60a0b0;font-style:italic>/* 整个structure block结束*/</span><span style=color:#007020>
</span></span></span></code></pre></td></tr></table></div></div><p>All values in this header are in big endian format(大端方式), the various fields in this header are defined more precisely below. All &ldquo;offset&rdquo; values are in bytes from the start of the header; that is from the physical base address of the device tree block.</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Here<span>&#39;</span>s the basic structure of a single node:
</span></span><span style=display:flex><span>     * token OF_DT_BEGIN_NODE <span style=color:#666>(</span>that is 0x00000001<span style=color:#666>)</span> // + 节点名字，表示节点开始
</span></span><span style=display:flex><span>     * <span style=color:#007020;font-weight:700>for</span> version <span style=color:#40a070>1</span> to 3, this is the node full path as a zero terminated string, starting with <span style=color:#4070a0>&#34;/&#34;</span>. For version <span style=color:#40a070>16</span> and later,
</span></span><span style=display:flex><span>       this is the node unit name only <span style=color:#666>(</span>or an empty string <span style=color:#007020;font-weight:700>for</span> the
</span></span><span style=display:flex><span>       root node<span style=color:#666>)</span>
</span></span><span style=display:flex><span>     * <span style=color:#666>[</span>align gap to next <span style=color:#40a070>4</span> bytes boundary<span style=color:#666>]</span>
</span></span><span style=display:flex><span>     * <span style=color:#007020;font-weight:700>for</span> each property:
</span></span><span style=display:flex><span>        * token OF_DT_PROP <span style=color:#666>(</span>that is 0x00000003<span style=color:#666>)</span> //属性开始
</span></span><span style=display:flex><span>        * 32-bit value of property value size in bytes <span style=color:#666>(</span>or <span style=color:#40a070>0</span> <span style=color:#007020;font-weight:700>if</span> no value<span style=color:#666>)</span> // value长度，字节
</span></span><span style=display:flex><span>        * 32-bit value of offset in string block of property name // 属性名字在string block中的偏移
</span></span><span style=display:flex><span>        * property value data <span style=color:#007020;font-weight:700>if</span> any // 属性的值
</span></span><span style=display:flex><span>        * <span style=color:#666>[</span>align gap to next <span style=color:#40a070>4</span> bytes boundary<span style=color:#666>]</span> //4字节对齐
</span></span><span style=display:flex><span>     * <span style=color:#666>[</span>child nodes <span style=color:#007020;font-weight:700>if</span> any<span style=color:#666>]</span>
</span></span><span style=display:flex><span>     * token OF_DT_END_NODE <span style=color:#666>(</span>that is 0x00000002<span style=color:#666>)</span> 
</span></span></code></pre></td></tr></table></div></div><p>​ Device tree &ldquo;strings&rdquo; block
​ In order to save space, property names, which are generally redundant, are stored separately in the &ldquo;strings&rdquo; block. This block is simply the whole bunch of zero terminated strings for all property names concatenated together. The device-tree property definitions in the structure block will contain offset values from the beginning of the strings block.</p><p>尝试自己分析dtb文件。</p><h2 id=第三课-内核对设备树的处理>第三课 内核对设备树的处理</h2><h3 id=1-从源头分析内核heads文件对dtb文件的简单处理>1. 从源头分析：内核head.S文件对dtb文件的简单处理</h3><p>bootloader启动内核时，会设置r0, r1, r2三个寄存器</p><ul><li>r0 设置为0</li><li>r1 设置machine_id , 使用设备树时该参数没有被使用, 传递给了<code>__machine_arch_type</code></li><li>r3 设置ATAGS或者DTB的启始地址 , 传递给了<code>__atags_pointer</code></li></ul><p>a.<code> __lookup_process_type</code> ： 使用汇编指令读取<code>CPUID</code>根据该ID找到对应的<code>proc_info_list</code>结构体，该结构体种含有这类CPU的初始化函数和信息；</p><p>b. <code>__vet_atags</code> ： 判断是否存在可用的ATAGS或者DTB；</p><p>c. <code>__create_page_tables</code> : 创建页表，即创建虚拟地址和物理地址的映射关系；</p><p>d. <code>__enable_mmu</code> : 使能MMU</p><p>e. <code>__mmap_switched</code> ：切换物理地址为虚拟地址</p><p>f. 把<code>bootloader</code>传入的<code>r2</code>寄存器中的参数，保存到变量<code>__atags_pointer</code>中</p><p>g. 调用C函数<code>start_kernel</code></p><h3 id=2-对设备树中平台信息的处理>2. 对设备树中平台信息的处理</h3><p>dts文件中“根节点”会声明兼容什么样的<code>machine_desc</code></p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4>4</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#666>/</span>{
</span></span><span style=display:flex><span>    model <span style=color:#666>=</span> <span style=color:#4070a0>&#34;SMDK2440&#34;</span>;
</span></span><span style=display:flex><span>    compatible <span style=color:#666>=</span> <span style=color:#4070a0>&#34;samsung, smdk2440&#34;</span>, <span style=color:#4070a0>&#34;samsung, smdk2410&#34;</span> <span style=color:#60a0b0;font-style:italic>//声明一系列兼容的单板，依兼容性高低排列。
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>}
</span></span></code></pre></td></tr></table></div></div><p>内核中的每一个<code>machine_desc</code>，同样也用字符串表明自己支持哪些单板</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8>8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9>9</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span><span style=color:#007020;font-weight:700>const</span> smdk2440_dt_compt[] __initconst <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#34;samsung, smdk2440&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#007020>NULL</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#06287e>MACHINE_START</span>(S3C2440, <span style=color:#4070a0>&#34;smdk2440&#34;</span>)
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    .dt_compat <span style=color:#666>=</span> smdk2440_dt_compt, <span style=color:#60a0b0;font-style:italic>//这也是一个字符串数组
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    ...
</span></span><span style=display:flex><span>MACHINE_END
</span></span></code></pre></td></tr></table></div></div><p>假设有多个<code>machine_desc</code>和<code>dts</code>符合，该选择哪一个? 看看代码执行过程</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-14>14</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>start_kernel <span style=color:#60a0b0;font-style:italic>// init/main.c
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#06287e>setup_arch</span>(<span style=color:#666>&amp;</span>command_line); <span style=color:#60a0b0;font-style:italic>// arch/arm/kernel/setup.c
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>		mdesc <span style=color:#666>=</span> <span style=color:#06287e>setup_machine_fdt</span>(__atags_pointer); <span style=color:#60a0b0;font-style:italic>// arch/arm/kernel/devtree.c
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>			<span style=color:#06287e>early_init_dt_verify</span>(<span style=color:#06287e>phys_to_virt</span>(dt_phys)) <span style=color:#60a0b0;font-style:italic>//此函数检查__atags_pointer是否有DTB头
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>                init_boot_params <span style=color:#666>=</span> params; <span style=color:#60a0b0;font-style:italic>//如果是DTB，则将DTB虚拟地址保存为全局变量
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>				mdesc <span style=color:#666>=</span> <span style=color:#06287e>of_flat_dt_match_machine</span>(mdesc_best, arch_get_next_mach); <span style=color:#60a0b0;font-style:italic>//找到最匹配的mdesc, arch_get_next_mach是一个函数指针，此函数会依次取出mdesc并返回m-&gt;dt_compat
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>                    <span style=color:#007020;font-weight:700>while</span>((data<span style=color:#666>==</span><span style=color:#06287e>get_next_compat</span>())) {
</span></span><span style=display:flex><span>                        score <span style=color:#666>=</span> <span style=color:#06287e>of_flat_dt_match</span>();
</span></span><span style=display:flex><span>                            <span style=color:#007020;font-weight:700>if</span> (score<span style=color:#666>&gt;</span><span style=color:#40a070>0</span> <span style=color:#666>&amp;&amp;</span> score<span style=color:#666>&lt;</span>best_score) {
</span></span><span style=display:flex><span>                                best_data <span style=color:#666>=</span> data;
</span></span><span style=display:flex><span>                                best_score <span style=color:#666>=</span> score;
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>		machine_desc <span style=color:#666>=</span> mdesc;
</span></span></code></pre></td></tr></table></div></div><h3 id=3-对设备树运行时配置信息的处理>3. 对设备树运行时配置信息的处理</h3><p>在上一节中找到最匹配的<code>mdesc</code>后<code>early_init_dt_scan_nodes()</code>函数中，处理以下内容。</p><p>a. <code>/chosen</code>中的<code>bootargs</code>属性值，存入全局变量<code>boot_command_line</code> :</p><p>b. 确定根节点的<code>#address-cells</code> 和<code>#size-cells</code>存入全局变量<code>dt_root_addr_cells</code>和<code>dt_root_size_cells</code>;</p><p>c. 解析<code>/memory</code>中的<code>reg</code>属性，提取出<code>base,size</code>最终调用<code>memblock_add(base,size)</code>;</p><h3 id=4-dtb文件转换为device_node>4. dtb文件转换为<code>device_node</code></h3><p>内存中如何保留<code>DTB</code>区域</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1>1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2>2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3>3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4>4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5>5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6>6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7>7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8>8</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#06287e>start_kernel</span>();
</span></span><span style=display:flex><span>    <span style=color:#06287e>setup_arch</span>();
</span></span><span style=display:flex><span>    	<span style=color:#06287e>arm_memblock_init</span>();
</span></span><span style=display:flex><span>    		<span style=color:#06287e>early_init_fdt_reserve_self</span>();
</span></span><span style=display:flex><span>                <span style=color:#60a0b0;font-style:italic>/* 把DTB所占区域保留下来，即调用 memblock_reserve() */</span>
</span></span><span style=display:flex><span>                <span style=color:#06287e>early_init_dt_reserve_memory_arch</span>(); 
</span></span><span style=display:flex><span>			<span style=color:#60a0b0;font-style:italic>/* 根据dtb中的memreserve信息调用memblock_reserve() */</span>
</span></span><span style=display:flex><span>    		<span style=color:#06287e>early_init_fdt_scan_reserved_mem</span>(); 
</span></span></code></pre></td></tr></table></div></div><p>设备树节点展开的样子</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> device_node {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>name; <span style=color:#60a0b0;font-style:italic>// 来自节点中的name属性，如果没有该属性，则设为NULL
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>type; <span style=color:#60a0b0;font-style:italic>// 来自节点中的device_type属性，如果没有该属性，则设为NULL
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> property{
</span></span><span style=display:flex><span>    <span style=color:#902000>char</span> <span style=color:#666>*</span>name;
</span></span><span style=display:flex><span>    <span style=color:#902000>int</span> length;
</span></span><span style=display:flex><span>    value;
</span></span><span style=display:flex><span>    next; 
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 画一下 结构之间的关系
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1>1</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#06287e>unflatten_device_tree</span>(<span style=color:#902000>void</span>)  <span style=color:#60a0b0;font-style:italic>// arch/arm/kernel/setup.c
</span></span></span></code></pre></td></tr></table></div></div><p>a. 在<code>DTB</code>文件中</p><p>​ 每一个节点都以<code>TAG(FDT_BEGIN_NODE, 0x00000001)</code>开始，节点内部可以嵌套其他节点；</p><p>​ 每一个属性都以<code>TAG(FDT_PROP, 0x00000003)</code>开始；</p><p>b. 每一个节点都转换为<code>struct device_node</code>结构体， 每一个属性都转换为<code>struct property</code>结构体；</p><p>函数调用过程</p><h3 id=5-device_node转换为platform_device>5. <code>device_node</code>转换为<code>platform_device</code></h3><p>dts->dtb->device_node->platform_device</p><p>两个问题：</p><p>a. 哪些<code>device_node</code>可以转换成<code>platform_device</code></p><p>​ 必须包含<code>compatible</code>属性</p><p>b. 怎么转换？</p><p>​ <code>platform_device</code>结构体中的<code>resource</code>数组，表示设备所需的资源，它来自于<code>device_node</code>的<code>reg</code>和<code>interrupts</code>属性。 <code>platform_device.dev.of_node</code>指向<code>device_node</code>可以通过它来获取其他属性。</p><p>​ 函数调用过程</p><div class=highlight><div style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1> 1</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2> 2</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3> 3</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4> 4</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5> 5</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6> 6</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7> 7</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8> 8</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9> 9</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-10>10</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-11>11</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-12>12</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-13>13</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-14>14</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-15>15</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-16>16</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-17>17</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-18>18</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-19>19</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-20>20</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-21>21</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-22>22</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-23>23</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-24>24</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-25>25</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-26>26</a>
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-27>27</a>
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>of_platform_default_populate_init
</span></span><span style=display:flex><span>    <span>此函数被编译到</span>initcall3段<span>，在内核启动时被调用</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>start_kernel
</span></span><span style=display:flex><span>    <span style=color:#06287e>reset_init</span>();
</span></span><span style=display:flex><span>		pid <span style=color:#666>=</span> <span style=color:#06287e>kernel_thread</span>(kernel_init, <span style=color:#007020>NULL</span>, CLONEFS)
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>kernel_init
</span></span><span style=display:flex><span>     <span style=color:#06287e>kernel_init_freeable</span>();
</span></span><span style=display:flex><span>		<span style=color:#06287e>do_basic_setup</span>();
</span></span><span style=display:flex><span>			<span style=color:#06287e>do_initcalls</span>();
</span></span><span style=display:flex><span>				<span style=color:#007020;font-weight:700>for</span> (level<span style=color:#666>=</span><span style=color:#40a070>0</span>; level<span style=color:#666>&lt;</span><span style=color:#06287e>ARRAY_SIZE</span>(initcall_levels)<span style=color:#666>-</span><span style=color:#40a070>1</span>; level<span style=color:#666>++</span>)
</span></span><span style=display:flex><span>                    <span style=color:#06287e>do_initcall_level</span>(level)
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>                    
</span></span><span style=display:flex><span>of_platform_default_populate_init生成platform_device的过程<span>：</span>
</span></span><span style=display:flex><span>	of_platform_default_populate_init
</span></span><span style=display:flex><span>        <span style=color:#06287e>of_platform_default_populate</span>(<span style=color:#007020>NULL</span>, <span style=color:#007020>NULL</span>, <span style=color:#007020>NULL</span>);
</span></span><span style=display:flex><span>			<span style=color:#06287e>of_platform_populate</span>(<span style=color:#007020>NULL</span>, of_dafault_bus_match_table, <span style=color:#007020>NULL</span>, <span style=color:#007020>NULL</span>)
</span></span><span style=display:flex><span>                <span style=color:#06287e>for_each_child_of_node</span>(root, child) {
</span></span><span style=display:flex><span>                	rc <span style=color:#666>=</span> <span style=color:#06287e>of_platform_bus_create</span>(child, matches, lookup, parent, <span style=color:#007020>true</span>);<span style=color:#60a0b0;font-style:italic>// 调用过程在后边
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>                    	dev <span style=color:#666>=</span> <span style=color:#06287e>of_device_alloc</span>(np, bus_id, parent); <span style=color:#60a0b0;font-style:italic>//根据device_node节点的属性设置platform_device的resource
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>                   <span style=color:#007020;font-weight:700>if</span> (rc) {
</span></span><span style=display:flex><span>                       <span style=color:#06287e>of_node_put</span>(child);
</span></span><span style=display:flex><span>                       <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>                   }
</span></span><span style=display:flex><span>            	}
</span></span></code></pre></td></tr></table></div></div><h3 id=6-平台设备和平台驱动的匹配>6. 平台设备和平台驱动的匹配</h3><p>匹配函数是<code>platform_bus_type.match</code>即<code>platform_match</code></p><p>a. 比较<code>platform_devive.driver_override</code>和<code>platform_driver.drv->name</code></p><p>b. 比较<code>platform_device.dev.of_node</code>的<code>compatible</code>属性和<code>platform_driver.drv->of_match_table</code></p><p>c. 比较<code>platform_device.name</code>和<code>platform_driver.id_table</code></p><p>d. 比较<code>platform_device.name</code>和<code>platform_driver.drv->name</code></p><p>有一个匹配成功，则匹配成功。</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>Yuanye Ma</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2019-04-15</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a href=https://github.com/gohugoio/hugoBasicExample rel=noopener target=_blank>See origin</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/devicetree/>devicetree</a>
<a href=/tags/kernel-driver/>Kernel Driver</a></div><nav class=post-nav><a class=prev href=/post/os/linux-kernel/input%E5%AD%90%E7%B3%BB%E7%BB%9F/><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417l277.93508-310.326815c11.338233-12.190647 11.035334-32.285311-.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"/></svg>
</i><span class="prev-text nav-default">input子系统</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/os/linux-kernel/2020-10-05-linux-i2c%E5%AD%90%E7%B3%BB%E7%BB%9F%E4%BB%A3%E7%A0%81%E8%B7%9F%E8%AF%BB/><span class="next-text nav-default">I2C子系统代码跟读</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="18" height="18"><path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697c-11.777231-11.500939-30.216186-10.304694-41.178865 2.712784z"/></svg></i></a></nav></footer></article></div><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#device-tree解决的问题>Device Tree解决的问题</a></li><li><a href=#编译设备树>编译设备树</a></li><li><a href=#缩写名词解释>缩写名词解释</a></li><li><a href=#设备树语法>设备树语法</a><ul><li><a href=#中断信息>中断信息</a></li></ul></li><li><a href=#常用of-api>常用OF API</a></li><li><a href=#设备树实战>设备树实战</a></li></ul><ul><li><a href=#第二课-设备树的规范dts和dtb>第二课 设备树的规范【dts和dtb】</a><ul><li><a href=#dts文件布局>DTS文件布局</a></li><li><a href=#dtb格式>DTB格式</a></li></ul></li><li><a href=#第三课-内核对设备树的处理>第三课 内核对设备树的处理</a><ul><li><a href=#1-从源头分析内核heads文件对dtb文件的简单处理>1. 从源头分析：内核head.S文件对dtb文件的简单处理</a></li><li><a href=#2-对设备树中平台信息的处理>2. 对设备树中平台信息的处理</a></li><li><a href=#3-对设备树运行时配置信息的处理>3. 对设备树运行时配置信息的处理</a></li><li><a href=#4-dtb文件转换为device_node>4. dtb文件转换为<code>device_node</code></a></li><li><a href=#5-device_node转换为platform_device>5. <code>device_node</code>转换为<code>platform_device</code></a></li><li><a href=#6-平台设备和平台驱动的匹配>6. 平台设备和平台驱动的匹配</a></li></ul></li></ul></nav></div></nav></div></main><footer id=footer class=footer><div class=icon-links><a href=yuanye.ma@qq.com rel="me noopener" class=iconfont title=email target=_blank><svg class="icon" viewBox="0 0 1451 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/YuanyeMa rel="me noopener" class=iconfont title=github target=_blank><svg class="icon" style="" viewBox="0 0 1024 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=https://www.zhihu.com/people/mr-kevin-92/posts rel="me noopener" class=iconfont title=zhihu target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="36" height="36"><path d="M351.791182 562.469462h192.945407c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262h159.282726s-.86367-67.402109-18.578124-67.402109-279.979646.0-279.979646.0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461s24.62791 5.832845 36.941354.0c12.313443-5.832845 68.050885-25.924439 84.252893-103.69571h86.570681c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262H109.86113c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449H279.868105c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513.0.0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-.055259.185218 167.855986 193.263655s22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-.045025.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"/><path d="M584.918753 182.033893v668.840094h70.318532l28.807093 80.512708 121.875768-80.512708h153.600307L959.520453 182.033893h-374.6017zM887.150192 778.934538h-79.837326l-99.578949 65.782216-23.537066-65.782216h-24.855084L659.341766 256.673847h227.807403V778.934538z"/></svg>
</a><a href="https://space.bilibili.com/159072924?spm_id_from=333.1007.0.0" rel="me noopener" class=iconfont title=bilibili target=_blank><svg class="icon" style="" viewBox="0 0 1024 1024" width="36" height="36" id="svg8"><path style="" d="M744.60599.00486267A41.779915 41.779915.0 00710.4184 18.673394L548.5048 255.32642h-11.70046a41.779915 41.779915.0 00-10.80295-7.84928L235.66 97.084498a41.779915 41.779915.0 00-20.07193-4.960864 41.779915 41.779915.0 00-18.3748 79.145436L359.4859 255.32642H128.16909c-49.458302.0-89.27932 39.82105-89.27932 89.27932v508.65224c0 49.4583 39.821018 89.27934 89.27932 89.27934h19.48445C149.12802 984.5043 179.92773 1024 224.79179 1024c44.86407.0 75.66379-39.4957 77.13826-81.46268H719.98116C721.45559 984.5043 752.25533 1024 797.1194 1024c44.86406.0 75.6638-39.4957 77.13824-81.46268h21.57323c49.45831.0 89.27936-39.82104 89.27936-89.27934V344.60574c0-49.45827-39.82105-89.27932-89.27936-89.27932H649.74567L779.38103 65.866924A41.779915 41.779915.0 00744.60599.00486267zM644.49108 418.70871c6.29985.21538 12.44451 2.01107 17.86888 5.22196l171.36218 98.10771c18.23417 10.21935 24.63334 33.34627 14.24614 51.48533-10.38726 18.13909-33.57344 24.32718-51.61587 13.77296L624.9903 489.18895c-15.21356-8.41858-22.66871-26.1765-18.03211-42.93436 4.63664-16.75784 20.15573-28.14465 37.53289-27.54588zM350.2006 432.31846c16.89952.0317 31.69582 11.33328 36.17844 27.62747 4.48262 16.2942-2.44981 33.57765-16.95507 42.24898l-140.7157 86.91312c-17.68528 11.18244-41.09629 5.77692-52.08912-12.02686-10.99282-17.80373-5.33855-41.15658 12.58167-51.95857L329.9002 438.2095c6.0643-3.86439 13.10951-5.90891 20.3004-5.89104zM501.605 641.53985c3.75002-.15248 7.48645.53903 10.93349 2.0235.15842.0637.31618.12888.47325.19582.59328.27092 1.17574.56489 1.74609.88121.15868.0854.31643.17233.47325.2611.55694.32165 1.10131.66458 1.63185 1.02807.16455.1123.32777.2265.48956.34269.50382.36781.99371.75428 1.46868 1.15864.18724.15504.37218.31282.55484.47323.43271.38784.8518.79061 1.25653 1.20756.15449.16114.30679.32437.45693.48959.40798.44266.79989.89988 1.17494 1.37076.17799.22544.35205.45395.5222.68538.25932.34701.50964.70071.75064 1.06071.26712.39516.52286.79784.76699 1.20757.16907.29043.33231.58424.48957.88123.21836.41297.42513.83199.62009 1.25653.14836.32333.28983.64976.42429.97911.21319.51552.40915 1.03801.58747 1.5666.0677.19499.13296.39085.19582.58748.18652.60823.34984 1.22334.48957 1.84399.0397.16277.0779.32601.11423.48957.1436.69112.25788 1.38801.34269 2.08877.005.0381.0111.0761.0163.11424.0857.78056.13474 1.56471.14687 2.34988.005.0543.0111.10879.0163.1632.0.0-.008 1.12132.0 1.45234.0.0-.14697 17.84761 5.89102 34.12231 3.01902 8.13734 7.33278 15.10615 12.61433 19.61501 5.28157 4.50889 11.42894 7.62081 23.64572 7.62081 12.2168.0 18.36416-3.11192 23.64573-7.62081 5.28154-4.50886 9.5953-11.47767 12.6143-19.61501 6.03799-16.2747 5.89103-34.12231 5.89103-34.12231-.44885-13.87045 10.45922-25.46302 24.3311-25.86506 13.87189-.40201 25.42828 10.53953 25.78348 24.41272.0.0 1.11929 25.7226-9.00791 53.01927-5.06359 13.64832-13.1986 28.46036-27.05631 40.29073-13.85772 11.83039-33.5454 19.63135-56.20142 19.63135-22.65603.0-42.34371-7.80096-56.20141-19.63135-4.1801-3.56856-7.78733-7.42433-10.99878-11.42303-3.21235 4.00037-6.81703 7.85309-10.99876 11.42303-13.85773 11.83039-33.5454 19.63135-56.20144 19.63135-22.65601.0-42.3437-7.80096-56.2014-19.63135-13.85775-11.83037-21.99272-26.64241-27.05632-40.29073-10.12725-27.29667-9.00789-53.01928-9.00789-53.01927.20714-13.83687 11.58744-24.88848 25.42444-24.69013 14.1263.19991 25.2971 12.0278 24.69011 26.14247.0.0-.14697 17.84761 5.89103 34.12231 3.01902 8.13734 7.31646 15.10615 12.598 19.61501 5.28155 4.50889 11.44526 7.62081 23.66203 7.62081 12.21681.0 18.36418-3.11192 23.64573-7.62081 5.28154-4.50886 9.57899-11.47767 12.598-19.61501 5.76352-15.53489 5.89112-32.05691 5.89103-33.56746.006-.37466.0111-1.05336.0163-1.20759-.0117-.74583.0105-1.49177.0652-2.23565.009-.15784.0204-.31561.0327-.47324.14204-1.56859.43163-3.12027.86487-4.63449.0213-.0763.0433-.15244.0652-.22848 3.0335-10.25748 12.24157-17.46007 22.92769-17.93417z" id="rect824"/></svg>
</a><a href=/index.xml rel="noopener alternate" type=application/rss+xml class=iconfont title=rss target=_blank><svg class="icon" viewBox="0 0 1024 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="30" height="30"><path d="M819.157333 1024C819.157333 574.592 449.408 204.8.0 204.8V0c561.706667.0 1024 462.293333 1024 1024H819.157333zM140.416 743.04a140.8 140.8.0 01140.501333 140.586667A140.928 140.928.0 01140.074667 1024C62.72 1024 0 961.109333.0 883.626667S62.933333 743.082667 140.416 743.04zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667v-199.04c372.352.0 678.784 306.517333 678.784 678.826667z"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2024
<span class=heart><i class=iconfont><svg class="icon" viewBox="0 0 1025 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="14" height="14"><path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7.0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1.0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2.0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3.1-42.5-8-83.6-24-122.2z" fill="#8a8a8a"/></svg>
</i></span><span class=author>Yuanye Ma</span></span></div></footer><div class=button__back-to-top><a href=#back-to-top><i class=iconfont><svg class="icon" viewBox="0 0 1024 1024" xmlns:xlink="http://www.w3.org/1999/xlink" width="35" height="35"><path d="M510.866688 227.694839 95.449397 629.218702h235.761562L329.15309 958.01517h362.40389L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777h894.052392v131.813095H63.840492V63.962777zm0 0"/></svg></i></a></div></div><script type=text/javascript src=/lib/jquery/jquery-3.7.1.min.js></script><script type=text/javascript src=/lib/slideout/slideout-1.0.1.min.js></script><script type=text/javascript src=/js/main.1f1ab71292e8ae0addbb90a5827f619e1cc7eba4a57b08930f33e5d8700d84be.js integrity="sha256-Hxq3EpLorgrdu5Clgn9hnhzH66SlewiTDzPl2HANhL4=" crossorigin=anonymous></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>