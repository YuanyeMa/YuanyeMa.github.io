<!DOCTYPE html>
<html
  lang="en"
  itemscope
  itemtype="http://schema.org/WebPage"
>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
          x86平台linux系统调用分析 - Yuanye Ma&#39;s Blog
        </title>
    

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Yuanye Ma" />
  <meta name="description" content="x86平台linux系统调用分析 [toc] kernel version : linux 2.6.30.4 x86 系统调用整体流程 用户空间调用libc库的syscall函数，此函数内嵌汇编，汇编代码先将系统调" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.125.4" />


<link rel="canonical" href="http://0.0.0.0:1313/post/os/x86%E5%B9%B3%E5%8F%B0linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/x86%E5%B9%B3%E5%8F%B0linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.e826e860368147e5a6685e686355e4d7789023c18c9ea2e78b35f6786ce92736.css" integrity="sha256-6CboYDaBR&#43;WmaF5oY1Xk13iQI8GMnqLnizX2eGzpJzY=" media="screen" crossorigin="anonymous">







<meta property="og:url" content="http://0.0.0.0:1313/post/os/x86%E5%B9%B3%E5%8F%B0linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/x86%E5%B9%B3%E5%8F%B0linux%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/">
  <meta property="og:site_name" content="Yuanye Ma&#39;s Blog">
  <meta property="og:title" content="x86平台linux系统调用分析">
  <meta property="og:description" content="x86平台linux系统调用分析 [toc] kernel version : linux 2.6.30.4 x86 系统调用整体流程 用户空间调用libc库的syscall函数，此函数内嵌汇编，汇编代码先将系统调">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2019-04-15T16:01:23+08:00">
    <meta property="article:modified_time" content="2019-04-15T16:01:23+08:00">
    <meta property="article:tag" content="操作系统">

  <meta itemprop="name" content="x86平台linux系统调用分析">
  <meta itemprop="description" content="x86平台linux系统调用分析 [toc] kernel version : linux 2.6.30.4 x86 系统调用整体流程 用户空间调用libc库的syscall函数，此函数内嵌汇编，汇编代码先将系统调">
  <meta itemprop="datePublished" content="2019-04-15T16:01:23+08:00">
  <meta itemprop="dateModified" content="2019-04-15T16:01:23+08:00">
  <meta itemprop="wordCount" content="3732">
  <meta itemprop="keywords" content="操作系统"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="x86平台linux系统调用分析">
<meta name="twitter:description" content="x86平台linux系统调用分析 [toc] kernel version : linux 2.6.30.4 x86 系统调用整体流程 用户空间调用libc库的syscall函数，此函数内嵌汇编，汇编代码先将系统调">

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




  </head>
  <body>
    <div id="back-to-top"></div>

    <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">功不唐捐</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/about/">About</a>
          
        
      </li>
    

    
  </ul>
</nav>


    
      






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    

    

    <header id="header" class="header">
      <div class="logo-wrapper">
  <a href="/" class="logo">
    
      功不唐捐
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://0.0.0.0:1313/about/">About</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

    </header>

    <div id="mobile-panel">
      <main id="main" class="main bg-llight wallpaper">
        <div class="content-wrapper">
    <div id="content" class="content">
      <article class="post">
        
        <header class="post-header">
          <h1 class="post-title">x86平台linux系统调用分析</h1>
          

          <div class="post-meta">
  <div class="post-meta-author">
    by
      <a href="/about">
        <span class="post-meta-author-name">
          Yuanye Ma
        </span>
      </a>
    
  </div>

  <div class="post-meta-time">
    <time datetime="2019-04-15">
      2019-04-15
    </time>
  </div>

  


  <div class="post-meta__right">
    

    <div class="post-meta-category">
        <a href="http://0.0.0.0:1313/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"> 操作系统 </a>
          
      </div>


    
    


    
    
  </div>
</div>

        </header>

        
        <div class="post-content">
          <h1 id="x86平台linux系统调用分析">x86平台linux系统调用分析</h1>
<p>[toc]</p>
<p>kernel version : linux 2.6.30.4</p>
<h2 id="x86-系统调用整体流程">x86 系统调用整体流程</h2>
<p><img alt="chenweixiang.github.io系统调用章节" src="http://chenweixiang.github.io/assets/System_Call_Procedure.jpg"></p>
<p>用户空间调用<code>libc</code>库的<code>syscall</code>函数，此函数内嵌汇编，汇编代码先将系统调用号写入<code>eax</code>寄存器，其他参数写入<code>ebx ecx edx esi edi</code>五个寄存器，若参数总个数超过五个，则应该用一个单独的寄存器存放指向所有这些参数在用户空间地址的指针。然后调用<code>int 0x80</code>指令陷入内核。</p>
<p><img alt="system_call_process" src="system_call_process.png"></p>
<p>CPU从<code>IDTR</code>中得到<code>IDT</code>（中断向量表）地址，并根据中断号(0x80)找到<code>IDT</code>下标为<code>0x80</code>的元素，即门描述符，检查<code>CPL=3</code>, 门描述符<code>DPL=0</code>，不相符，发生栈切换。</p>
<p>CPU根据寄存器<code>TR</code>的内容找到当前<code>TSS</code>,并根据目标代码段的<code>DPL</code>，从<code>TSS</code>结构中取出新的堆栈指针（SS和ESP），并装入其堆栈段寄存器<code>SS</code>和堆栈指针<code>ESP</code>中，达到更换堆栈的目的。这种情况下CPU不但要将<code>EFLAGS</code>、返回地址以及出错代码压入堆栈，还要先将原来的堆栈指针也压入新堆栈中。</p>
<p><img alt="stack_sw" src="stack_sw.png"></p>
<p>栈切换完成后，CPU从陷阱门描述符中找到中断服务程序所在内存段的段选择子和地址偏移，根据段选择子去<code>GDT</code>或者<code>LDT</code>中找到对应的段描述符，装入<code>CS</code>段选择寄存器，找到段基地址，并加上地址偏移后找到中断服务程序入口地址，跳转过去运行。</p>
<h2 id="中断向量表idt的初始化">中断向量表IDT的初始化</h2>
<p>基于<code>linux 2.6.30.4</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* &#34;arch/x86/kernel/traps.c&#34; */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> __init <span style="color:#a6e22e">trap_init</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{	
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>divide_error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate_ist</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>debug, DEBUG_STACK);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate_ist</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>nmi, NMI_STACK);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* int3 can be called from all */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_system_intr_gate_ist</span>(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">&amp;</span>int3, DEBUG_STACK);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* int4 can be called from all */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_system_intr_gate</span>(<span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>overflow);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">5</span>, <span style="color:#f92672">&amp;</span>bounds);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">6</span>, <span style="color:#f92672">&amp;</span>invalid_op);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">7</span>, <span style="color:#f92672">&amp;</span>device_not_available);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_task_gate</span>(<span style="color:#ae81ff">8</span>, GDT_ENTRY_DOUBLEFAULT_TSS);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">9</span>, <span style="color:#f92672">&amp;</span>coprocessor_segment_overrun);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">10</span>, <span style="color:#f92672">&amp;</span>invalid_TSS);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">11</span>, <span style="color:#f92672">&amp;</span>segment_not_present);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate_ist</span>(<span style="color:#ae81ff">12</span>, <span style="color:#f92672">&amp;</span>stack_segment, STACKFAULT_STACK);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">13</span>, <span style="color:#f92672">&amp;</span>general_protection);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">14</span>, <span style="color:#f92672">&amp;</span>page_fault);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">15</span>, <span style="color:#f92672">&amp;</span>spurious_interrupt_bug);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">16</span>, <span style="color:#f92672">&amp;</span>coprocessor_error);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_intr_gate</span>(<span style="color:#ae81ff">17</span>, <span style="color:#f92672">&amp;</span>alignment_check);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">set_system_trap_gate</span>(SYSCALL_VECTOR, <span style="color:#f92672">&amp;</span>system_call);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    SYSCALL_VECTOR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    arch/x86/include/asm/irq_vectors.h:36:# define SYSCALL_VECTOR                   0x80
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    asmlinkage int system_call(void);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cpu_init</span>();		
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>程序中首先设置中断向量表的头19个陷阱门，这些中断向量表都是CPU保留用于异常处理的。</p>
<p><code>set_intr_gate()</code> 等函数都调用了<code>_set_gate()</code>函数设置门描述符，本文重点分析系统调用相关的内容，即 <code>set_system_trap_gate()</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*&#34;arch/x86/include/asm/desc.h&#34; */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	set_system_trap_gate(SYSCALL_VECTOR, &amp;system_call); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    		n = SYSCALL_VECTOR = 0x80;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    		addr = &amp;system_call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">set_system_trap_gate</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> n, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">BUG_ON</span>((<span style="color:#66d9ef">unsigned</span>)n <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0xFF</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">_set_gate</span>(n, GATE_TRAP, addr, <span style="color:#ae81ff">0x3</span>, <span style="color:#ae81ff">0</span>, __KERNEL_CS);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>_set_gate()</code>函数完成设置门描述符的工作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	_set_gate(n, GATE_TRAP, addr, 0x3, 0, __KERNEL_CS); 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	&#34;arch/x86/include/asm/desc_defs.h&#34;	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        enum {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                GATE_INTERRUPT = 0xE,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                GATE_TRAP = 0xF,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                GATE_CALL = 0xC,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                GATE_TASK = 0x5,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        };
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	arch/x86/include/asm/segment.h 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			#define __KERNEL_CS     (GDT_ENTRY_KERNEL_CS * 8)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			#define GDT_ENTRY_KERNEL_CS 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">_set_gate</span>(<span style="color:#66d9ef">int</span> gate, <span style="color:#66d9ef">unsigned</span> type, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr,
</span></span><span style="display:flex;"><span>                             <span style="color:#66d9ef">unsigned</span> dpl, <span style="color:#66d9ef">unsigned</span> ist, <span style="color:#66d9ef">unsigned</span> seg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    参数如下：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    	gate = n = SYSCALL_VECTOR = 0x80;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        type = GATE_TRAP = 0xF;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        addr = &amp;system_call;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        dpl = 0x3;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        ist = 0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        seg = __KERNEL_CS = 2*8;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    */</span>
</span></span><span style="display:flex;"><span>        gate_desc s;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pack_gate</span>(<span style="color:#f92672">&amp;</span>s, type, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)addr, dpl, ist, seg);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * does not need to be atomic because it is only done once at
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * setup time
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">write_idt_entry</span>(idt_table, gate, <span style="color:#f92672">&amp;</span>s);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img alt="trap_gate" src="trap_gate.png"></p>
<p>先看看第一行<code>gate_desc s;</code>，主要分配了门描述符的结构。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*gate_desc 结构 &#34;arch/x86/include/asm/desc_defs.h&#34; */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> desc_struct gate_desc;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> desc_struct {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> a; <span style="color:#75715e">// 4字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> b; <span style="color:#75715e">// 4字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>                        u16 limit0; <span style="color:#75715e">// 2字节 位移的低16位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        u16 base0;  <span style="color:#75715e">// 2字节 段选择码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">unsigned</span> base1: <span style="color:#ae81ff">8</span>, type: <span style="color:#ae81ff">4</span>, s: <span style="color:#ae81ff">1</span>, dpl: <span style="color:#ae81ff">2</span>, p: <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 2字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                        <span style="color:#66d9ef">unsigned</span> limit: <span style="color:#ae81ff">4</span>, avl: <span style="color:#ae81ff">1</span>, l: <span style="color:#ae81ff">1</span>, d: <span style="color:#ae81ff">1</span>, g: <span style="color:#ae81ff">1</span>, base2: <span style="color:#ae81ff">8</span>; <span style="color:#75715e">//2字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                };
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>} <span style="color:#a6e22e">__attribute__</span>((packed));
</span></span></code></pre></div><blockquote>
<p><strong>attribute</strong> ((packed)) 的作用就是告诉编译器取消结构在编译过程中的优化对齐,按照实际占用字节数进行对齐，是GCC特有的语法。这个功能是跟操作系统没关系，跟编译器有关，gcc编译器不是紧凑模式的，在windows下，用vc的编译器也不是紧凑的，用tc的编译器就是紧凑的。</p>
<p>例如：</p>
<p>在TC下：struct my{ char ch; int a;} sizeof(int)=2;sizeof(my)=3;（紧凑模式）<br>
在GCC下：struct my{ char ch; int a;} sizeof(int)=4;sizeof(my)=8;（非紧凑模式）<br>
在GCC下：struct my{ char ch; int a;}<strong>attrubte</strong> ((packed)) sizeof(int)=4;sizeof(my)=5</p>
</blockquote>
<p><code>struct desc_struct</code>包含一个联合体，可以用其中任何一种类型，后边可以看到<code>pack_gate()</code>函数使用联合体中的第一种，即<code>struct {unsigned int a; unsigned  int b};</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	gate = n = SYSCALL_VECTOR = 0x80;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	type = GATE_TRAP = 0xF;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    addr = &amp;system_call;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    dpl = 0x3;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ist = 0;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    seg = __KERNEL_CS = 2*8;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pack_gate</span>(gate_desc <span style="color:#f92672">*</span>gate, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> type,
</span></span><span style="display:flex;"><span>                             <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> base, <span style="color:#66d9ef">unsigned</span> dpl, <span style="color:#66d9ef">unsigned</span> flags,
</span></span><span style="display:flex;"><span>                             <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span> seg)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        gate<span style="color:#f92672">-&gt;</span>a <span style="color:#f92672">=</span> (seg <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">|</span> (base <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffff</span>);
</span></span><span style="display:flex;"><span>        gate<span style="color:#f92672">-&gt;</span>b <span style="color:#f92672">=</span> (base <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffff0000</span>) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                  (((<span style="color:#ae81ff">0x80</span> <span style="color:#f92672">|</span> type <span style="color:#f92672">|</span> (dpl <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">5</span>)) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>pack_gate()</code>此函数包装一个陷阱门描述符。<code>gate-&gt;a</code>在低地址。</p>
<blockquote>
<pre><code>/*
gate-&gt;a = (seg &lt;&lt; 16) | (base &amp; 0xffff);
gate-&gt;a = ((2*8)&lt;&lt;16 | (&amp;system_call &amp; 0xffff);
(&amp;system_call &amp; 0xffff) : 中断服务函数地址段内偏移的低16位
((2*8)&lt;&lt;16  : 段选择码，即中断服务函数所在代码段选择子在GTD或者LDT中的下标。

gate-&gt;b = (base &amp; 0xffff0000) | (((0x80 | type | (dpl &lt;&lt; 5)) &amp; 0xff) &lt;&lt; 8);
gate-&gt;b = (&amp;system_call &amp; 0xffff0000) | (((0x80 | 0xF  | (0x3 &lt;&lt; 5)) &amp; 0xff) &lt;&lt; 8)
解析
0x80 : 1000 0000
0xf  : 0000 1111
0x3  : 0000 0011
0xff : 1111 1111

0x80 | 0xF = 0x8f : 1000 1111
0x3 &lt;&lt; 5 = 0110 0000
(0x80 | 0xF  | (0x3 &lt;&lt; 5)) = 1110 1111
((0x80 | 0xF  | (0x3 &lt;&lt; 5)) &amp; 0xff) = 1110 1111
(((0x80 | 0xF  | (0x3 &lt;&lt; 5)) &amp; 0xff) &lt;&lt; 8) = 1110 1111 0000 0000
对应到门描述符
	(&amp;system_call &amp; 0xffff0000) : 中断服务函数地址段内偏移的高16位
	P ： 1 ： 内存段在内存中
	DPL ： 11 ：DPL = 3
    0 ： 永远为0
	D ： 1 表示32位
	111 ： 类型码 ： 陷阱门
*/
</code></pre>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define write_idt_entry(dt, entry, g)           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        native_write_idt_entry(dt, entry, g)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    idt = idt_table;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    entry = gate = n = SYSCALL_VECTOR = 0x80;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    gate = &amp;s；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">其中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	gate_desc idt_table[256] 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			__attribute__((__section__(&#34;.data.idt&#34;))) = { { { { 0, 0 } } }, };
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	typedef struct desc_struct gate_desc;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">native_write_idt_entry</span>(gate_desc <span style="color:#f92672">*</span>idt, <span style="color:#66d9ef">int</span> entry,
</span></span><span style="display:flex;"><span>                                          <span style="color:#66d9ef">const</span> gate_desc <span style="color:#f92672">*</span>gate)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>idt[entry], gate, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>gate));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>native_write_idt_entry()</code>此函数将<code>pack_gate()</code>函数封装的陷阱门描述符拷贝进<code>idt</code>的0x80位置。</p>
<h2 id="系统调用的中断服务程序分析">系统调用的中断服务程序分析</h2>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">/*arch/x86/kernel/entry_32.S*/

        # system call handler stub
ENTRY(system_call)
        RING0_INT_FRAME                 # can&#39;t unwind into user space anyway
        pushl %eax                      # save orig_eax
        CFI_ADJUST_CFA_OFFSET 4
        SAVE_ALL
        GET_THREAD_INFO(%ebp)			# system call tracing in operation / emulation
        testl $_TIF_WORK_SYSCALL_ENTRY,TI_flags(%ebp)
        jnz syscall_trace_entry
        cmpl $(nr_syscalls), %eax
        jae syscall_badsys
syscall_call:
        call *sys_call_table(,%eax,4)
        movl %eax,PT_EAX(%esp)          # store the return value
syscall_exit:
        LOCKDEP_SYS_EXIT
        DISABLE_INTERRUPTS(CLBR_ANY)    # make sure we don&#39;t miss an interrupt
                                        # setting need_resched or sigpending
                                        # between sampling and the iret
        TRACE_IRQS_OFF
        movl TI_flags(%ebp), %ecx
        testl $_TIF_ALLWORK_MASK, %ecx  # current-&gt;work
        jne syscall_exit_work
</code></pre><p>先将<code>%eax</code>（系统调用号）压入栈，然后调用<code>SAVE_ALL</code>保存中断现场，检查系统调用号，跳转到相应的而系统调用函数去执行<code>call *sys_call_table(,%eax,4)</code>，<code>sys_call_table</code>定义如下，是一个函数指针列表。</p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">/*arch/x86/kernel/syscall_table_32.S*/
ENTRY(sys_call_table)
        .long sys_restart_syscall       /* 0 - old &#34;setup()&#34; system call, used for restarting */
        .long sys_exit
        .long ptregs_fork
        .long sys_read
        .long sys_write
        .long sys_open          /* 5 */
        .long sys_close
        .long sys_waitpid
        .long sys_creat
        .long sys_link
        .long sys_unlink        /* 10 */
        .long ptregs_execve
        .long sys_chdir
        .long sys_time
        /* 略 */
</code></pre><p>关于<code>SAVE_ALL</code></p>
<pre tabindex="0"><code class="language-assembly" data-lang="assembly">.macro SAVE_ALL
        cld
        PUSH_GS
        pushl %fs
        CFI_ADJUST_CFA_OFFSET 4  # 这些宏暂时不知道干啥的 
        /*CFI_REL_OFFSET fs, 0;*/
        pushl %es
        CFI_ADJUST_CFA_OFFSET 4
        /*CFI_REL_OFFSET es, 0;*/
        pushl %ds
        CFI_ADJUST_CFA_OFFSET 4
        /*CFI_REL_OFFSET ds, 0;*/
        pushl %eax
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET eax, 0
        pushl %ebp
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET ebp, 0
        pushl %edi
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET edi, 0
        pushl %esi
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET esi, 0
        pushl %edx
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET edx, 0
        pushl %ecx
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET ecx,
        pushl %ebx
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET ebx, 0
        movl $(__USER_DS), %edx
        movl %edx, %ds
        movl %edx, %es
        movl $(__KERNEL_PERCPU), %edx
        movl %edx, %fs
        SET_KERNEL_GS %edx
.endm
</code></pre><p>穿插一些宏暂时不知道干什么的，先不管。主要看一下寄存器的压栈顺序：<code>%es %ds %eax %ebp %edi %esi %edx %ecx %ebx </code></p>
<p><img alt="image-stack_status" src="stack_status.png"></p>
<h2 id="系统调用的定义">系统调用的定义</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* include/linux/syscalls.h */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE0(sname)                                  \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        static const struct syscall_metadata __used             \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          __attribute__((__aligned__(4)))                       \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          __attribute__((section(&#34;__syscalls_metadata&#34;)))       \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">          __syscall_meta_##sname = {                            \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                .name           = &#34;sys_&#34;#sname,                 \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                .nb_args        = 0,                            \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        };                                                      \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        asmlinkage long sys_##sname(void)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE0(name)      asmlinkage long sys_##name(void)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE1(name, ...) SYSCALL_DEFINEx(1, _##name, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE2(name, ...) SYSCALL_DEFINEx(2, _##name, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE3(name, ...) SYSCALL_DEFINEx(3, _##name, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE4(name, ...) SYSCALL_DEFINEx(4, _##name, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE5(name, ...) SYSCALL_DEFINEx(5, _##name, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE6(name, ...) SYSCALL_DEFINEx(6, _##name, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 其中 SYSCALL_DEFINEx*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_FTRACE_SYSCALLS </span><span style="color:#75715e">/*ftrace是内核提供的一种调试工具*/</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINEx(x, sname, ...)                          \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        static const char *types_##sname[] = {                  \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                __SC_STR_TDECL##x(__VA_ARGS__)                  \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        };                                                      \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        static const char *args_##sname[] = {                   \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                __SC_STR_ADECL##x(__VA_ARGS__)                  \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        };                                                      \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        SYSCALL_METADATA(sname, x);                             \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        __SYSCALL_DEFINEx(x, sname, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINEx(x, sname, ...)                          \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        __SYSCALL_DEFINEx(x, sname, __VA_ARGS__)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_HAVE_SYSCALL_WRAPPERS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE(name) static inline long SYSC_##name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define __SYSCALL_DEFINEx(x, name, ...)                                 \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        asmlinkage long sys##name(__SC_DECL##x(__VA_ARGS__));           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        static inline long SYSC##name(__SC_DECL##x(__VA_ARGS__));       \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        asmlinkage long SyS##name(__SC_LONG##x(__VA_ARGS__))            \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        {                                                               \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                __SC_TEST##x(__VA_ARGS__);                              \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                return (long) SYSC##name(__SC_CAST##x(__VA_ARGS__));    \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        }                                                               \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        SYSCALL_ALIAS(sys##name, SyS##name);                            \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        static inline long SYSC##name(__SC_DECL##x(__VA_ARGS__))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else </span><span style="color:#75715e">/* CONFIG_HAVE_SYSCALL_WRAPPERS */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SYSCALL_DEFINE(name) asmlinkage long sys_##name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __SYSCALL_DEFINEx(x, name, ...)                                 \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        asmlinkage long sys##name(__SC_DECL##x(__VA_ARGS__))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_HAVE_SYSCALL_WRAPPERS */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 后边是所有系统调用的函数声明 */</span>
</span></span><span style="display:flex;"><span>asmlinkage <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sys_time</span>(<span style="color:#66d9ef">time_t</span> __user <span style="color:#f92672">*</span>tloc);
</span></span></code></pre></div><p>系统调用的定义分布在内核源代码多个源文件中<code>find . -type f -name &quot;*.c&quot; | xargs grep SYSCALL_DEFINE | wc -l</code></p>
<h2 id="系统调用号">系统调用号</h2>
<p>每个系统调用<code>xxx</code>都对应着一个系统调用号<code>__NR_xxx</code>。当应用程序调用某系统调用时，寄存器eax中保存该系统调用对应的系统调用号。系统调用号定义于如下头文件中：</p>
<pre tabindex="0"><code>include/linux/unistd.h				
+-  arch/x86/include/asm/unistd.h
    +-  arch/x86/include/asm/unistd_32.h
    |   +-  ...
    |   +-  #define __NR_process_vm_writev  348
    |   +-  #define NR_syscalls             349
    +-  arch/x86/include/asm/unistd_64.h
        +-  ...
        +-  #define __NR_process_vm_writev  311
        +-  __SYSCALL(__NR_process_vm_writev, sys_process_vm_writev)
</code></pre><p>在应用程序中仅需包含头文件<code>#include &lt;unistd.h&gt;</code>即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#ifndef _LINUX_UNISTD_H_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _LINUX_UNISTD_H_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Include machine specific syscall numbers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* _LINUX_UNISTD_H_ */</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>对于x86而言，<code>asm/unistd.h</code>即为<code>arch/x86/include/asm/unistd.h</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#ifdef __KERNEL__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#  ifdef CONFIG_X86_32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#    include &#34;unistd_32.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#  else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#    include &#34;unistd_64.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#  endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#  ifdef __i386__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#    include &#34;unistd_32.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#  else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#    include &#34;unistd_64.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#  endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">对于</span>x86 <span style="color:#ae81ff">32</span><span style="color:#f92672">-</span>bit而言<span style="color:#960050;background-color:#1e0010">，</span>unistd_32.h即为arch<span style="color:#f92672">/</span>x86<span style="color:#f92672">/</span>include<span style="color:#f92672">/</span><span style="color:#66d9ef">asm</span><span style="color:#f92672">/</span>unistd_32.h:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_restart_syscall		0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_exit			1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_fork			2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_read			3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_write			4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_open			5
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_close			6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_process_vm_readv		347
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_process_vm_writev		348
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef __KERNEL__
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define NR_syscalls			349
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><h2 id="系统调用的返回值">系统调用的返回值</h2>
<p>如果系统调用执行失败，系统调用并不直接返回错误码，而是将错误码保存到全局变量<code>errno</code>中，因而可根据<code>errno</code>的值来确定错误类型。错误码定义于如下头文件中：</p>
<pre tabindex="0"><code>include/linux/errno.h				// 错误码512-530
-&gt; arch/x86/include/asm/errno.h			// 仅包含asm-generic/errno.h，未新增错误码
   -&gt; include/asm-generic/errno.h		// 错误码35-133
      -&gt; include/asm-generic/errno-base.h	// 错误码1-34
</code></pre><p>也可以执行<code> man errno</code>查询到。</p>
<h2 id="新增系统调用">新增系统调用</h2>
<h3 id="通过修改内核代码">通过修改内核代码</h3>
<ul>
<li>确定新增的系统调用号
<ol>
<li>修改arch/x86/include/asm/unistd_32.h，为新增的系统调用定义的系统调用号<code>#define _NR_testsyscall 350</code></li>
<li>修改arch/x86/kernel/syscall_table_32.S，将新增的系统调用加入到系统调用表，即数组sys_call_table中写入：<code>long sys_testsyscall  /* 350 */</code></li>
</ol>
</li>
<li>编写新增的系统调用
编写一个系统调用意味着要给内核增加一个函数，将该函数写入文件kernel/sys.c中，代码如下：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">SYSCALL_DEFINE0</span>(testsyscall)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console_print</span>(<span style="color:#e6db74">&#34;hello world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>使用新增的系统调用
因为C库中没有新增的系统调用的程序段，必须自己建立其代码，如下：
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#inculde &lt;syscalls.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">SYSCALL_DEFINE0</span>(testsyscall)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tsetsyscall</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<h3 id="通过编写插入内核模块">通过编写插入内核模块</h3>
<ul>
<li>编写系统调用内核模块
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#75715e">#inculde &lt;linux/kernel.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#inculde &lt;linux/module.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#inculde &lt;linux/modversions.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#inculde &lt;linux/sched.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">#inculde &lt;asm/uaccess.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">#define _NR_testsyscall 350
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>sys_call_table[];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  asmlinkage <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">testsyscall</span>()
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;hello world</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span>  <span style="color:#a6e22e">syscall_test_init</span>()
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      sys_call_table[_NR_tsetsyscall] <span style="color:#f92672">=</span> testsyscall;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;system call testsyscall() loaded success</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">module_init</span>(syscall_test_init);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">syscall_test_exit</span>()
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">module_exit</span>(syscall_test_exit)
</span></span></code></pre></div></li>
<li>编写使用新增的系统调用的代码</li>
<li>编译内核模块并插入内核模块</li>
</ul>
<h2 id="从用户空间直接访问系统调用">从用户空间直接访问系统调用</h2>
<p>方式一：通过C库函数，C库函数封装了所有的系统调用。</p>
<p>方式二：2.6.18版本之前的内核可以使用<code>_syscall</code>宏。但是自2.6.19版本开始，<code>_syscall</code>宏被废除，我们需要使用<code>syscall</code>函数，通过指定<code>系统调用号</code>和一组参数来调用系统调用。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/syscall.h&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt; </span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_gettid      224  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[])  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pid_t</span> tid;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    tid <span style="color:#f92672">=</span> <span style="color:#a6e22e">syscall</span>(__NR_gettid);  <span style="color:#75715e">//括号内参数直接写224也可以
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">/*也可以写成tid = syscall(SYS_gettid);*/</span>
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p><a href="https://www.jianshu.com/p/5e96fd50f3b5">参考</a></p>
<blockquote>
<p>注： syscall()函数是glibc中的一个用户空间函数，可以通过<code>man syscall</code>命令查看，函数声明在/usr/include/unistd.h中，对应系统调用号在/usr/include/asm-generic/unistd.h中声明。</p>
</blockquote>

        </div>

        
        
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Yuanye Ma</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2019-04-15
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a href="https://github.com/gohugoio/hugoBasicExample" rel="noopener" target="_blank">See origin</a></span>
  </p>
</div>



        
        


        <footer class="post-footer">
          <div class="post-tags">
              <a href="http://0.0.0.0:1313/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
                
            </div>


          
          <nav class="post-nav">
            
              <a class="prev" href="/post/os/x86%E5%B9%B3%E5%8F%B0%E9%80%9A%E7%94%A8%E4%B8%AD%E6%96%AD/x86%E5%B9%B3%E5%8F%B0%E9%80%9A%E7%94%A8%E4%B8%AD%E6%96%AD/">
                
                <i class="iconfont">
                  <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

                </i>
                <span class="prev-text nav-default">x86平台Linux中断机制</span>
                <span class="prev-text nav-mobile">Prev</span>
              </a>
            
              <a class="next" href="/post/os/2019-07-05-x86%E6%B1%87%E7%BC%96/">
                <span class="next-text nav-default">X86汇编</span>
                <span class="prev-text nav-mobile">Next</span>
                
                <i class="iconfont">
                  <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

                </i>
              </a>
          </nav>
        </footer>
      </article>

      
      


      
      


    </div>

    
    <nav class="toc" id="toc">
    <div class="toc-title">Table of Contents</div>
    <div class="toc-content custom-scrollbar">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#x86-系统调用整体流程">x86 系统调用整体流程</a></li>
    <li><a href="#中断向量表idt的初始化">中断向量表IDT的初始化</a></li>
    <li><a href="#系统调用的中断服务程序分析">系统调用的中断服务程序分析</a></li>
    <li><a href="#系统调用的定义">系统调用的定义</a></li>
    <li><a href="#系统调用号">系统调用号</a></li>
    <li><a href="#系统调用的返回值">系统调用的返回值</a></li>
    <li><a href="#新增系统调用">新增系统调用</a>
      <ul>
        <li><a href="#通过修改内核代码">通过修改内核代码</a></li>
        <li><a href="#通过编写插入内核模块">通过编写插入内核模块</a></li>
      </ul>
    </li>
    <li><a href="#从用户空间直接访问系统调用">从用户空间直接访问系统调用</a></li>
  </ul>
</nav>
    </div>
  </nav>


  </div>

      </main>

      <footer id="footer" class="footer">
        <div class="icon-links">
  
  
    <a href="yuanye.ma@qq.com" rel="me noopener" class="iconfont"
      title="email"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/YuanyeMa" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/mr-kevin-92" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>
  
    <a href="https://space.bilibili.com/159072924?spm_id_from=333.1007.0.0" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="http://0.0.0.0:1313/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    2024
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Yuanye Ma
        
      </span></span>

  
  

  
</div>

      </footer>

      <div class="button__back-to-top">
        <a href="#back-to-top">
          <i class="iconfont">
            
            <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

          </i>
        </a>
      </div>
    </div>
    
<script type="text/javascript" src="/lib/jquery/jquery-3.7.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.823efc68a3fe47916871970a683c47e53fce8735cd7c97764a761f2043c82f7e.js" integrity="sha256-gj78aKP&#43;R5FocZcKaDxH5T/OhzXNfJd2SnYfIEPIL34=" crossorigin="anonymous"></script>



  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>










  
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  

















  </body>
</html>
